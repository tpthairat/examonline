<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamOnline - ระบบสอบออนไลน์</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Prompt for Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX translation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        
        // Import Lucide Icons
        import { 
            Book, PlayCircle, FileText, LogOut, User, Users, 
            CheckCircle, Clock, Award, BarChart2, Upload, Trash2, 
            Plus, Menu, X, AlertCircle, Unlock, Shield, Home, UserCheck, UserX, FileUp, Video, HelpCircle 
        } from 'lucide-react';

        // Import Firebase from Google CDN (Updated to 11.6.1)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, 
            deleteDoc, query, where, orderBy, setDoc, getDoc, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- 1. Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAUraFookA86wCxmR6KBRba5bvncFZHTUw",
            authDomain: "jastin-82769.firebaseapp.com",
            databaseURL: "https://jastin-82769-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jastin-82769",
            storageBucket: "jastin-82769.firebasestorage.app",
            messagingSenderId: "95091235116",
            appId: "1:95091235116:web:b230db5f3d0112ac1cb489",
            measurementId: "G-EEV77J3922"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Helper Functions for Strict Firestore Paths ---
        const getAppCollection = (collectionName) => {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        };

        const getAppDoc = (collectionName, docId) => {
            return doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId);
        };

        // --- Utility Components ---
        
        function ConfirmationModal({ isOpen, onClose, onConfirm, title, message, confirmText = "ยืนยัน", confirmColor = "bg-blue-600 hover:bg-blue-700" }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm">
                    <div className="w-full max-w-sm overflow-hidden rounded-xl bg-white shadow-2xl animate-fade-in-up">
                        <div className="p-6">
                            <h3 className="mb-2 text-lg font-bold text-gray-900">{title}</h3>
                            <p className="text-gray-600">{message}</p>
                        </div>
                        <div className="flex justify-end gap-3 bg-gray-50 px-6 py-4">
                            <button onClick={onClose} className="rounded-lg px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-200 transition">ยกเลิก</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className={`rounded-lg px-4 py-2 text-sm font-medium text-white transition shadow ${confirmColor}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const getYouTubeEmbedUrl = (url) => {
            let videoId = '';
            const match = url.match(/(?:v=|\/embed\/|\/v\/|youtu\.be\/|\/watch\?v=)([^#\&\?]*).*/);
            if (match && match[1]) {
                videoId = match[1];
            }
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            return url;
        };

        // --- 2. Components ---

        function ExamApp() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('auth');

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Custom token auth failed", e);
                        }
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        try {
                            const userRef = getAppDoc('users', currentUser.uid);
                            const snapshot = await getDoc(userRef);
                            
                            if (snapshot.exists()) {
                                const data = snapshot.data();
                                setUserProfile(data);
                                if (data.approved) {
                                    setCurrentView(data.role === 'admin' ? 'admin-dashboard' : 'user-dashboard');
                                } else {
                                    setCurrentView('auth'); 
                                }
                            } else {
                                const isAdminEmail = currentUser.email && currentUser.email.toLowerCase().includes('admin');
                                const newProfile = {
                                    uid: currentUser.uid,
                                    email: currentUser.email || '',
                                    role: isAdminEmail ? 'admin' : 'user',
                                    approved: !!isAdminEmail
                                };
                                await setDoc(userRef, newProfile);
                                setUserProfile(newProfile);
                                setCurrentView(isAdminEmail ? 'admin-dashboard' : 'auth');
                            }
                        } catch (err) {
                            console.error("Profile Error:", err);
                        }
                    } else {
                        setUser(null);
                        setUserProfile(null);
                        setCurrentView('auth');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-gray-50">
                        <div className="flex flex-col items-center animate-pulse">
                            <div className="h-12 w-12 rounded-full bg-blue-200 mb-4"></div>
                            <div className="h-4 w-32 bg-gray-200 rounded"></div>
                            <p className="mt-2 text-sm text-gray-400">กำลังโหลดระบบ...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {currentView === 'auth' && <AuthScreen user={user} userProfile={userProfile} />}
                    {currentView === 'user-dashboard' && <UserDashboard user={user} onLogout={() => signOut(auth)} />}
                    {currentView === 'admin-dashboard' && <AdminDashboard user={user} onLogout={() => signOut(auth)} onSwitchView={() => setCurrentView('user-dashboard')} />}
                </div>
            );
        }

        function AuthScreen({ user, userProfile }) {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [busy, setBusy] = useState(false);

            if (user && userProfile && !userProfile.approved) {
                return (
                    <div className="flex min-h-screen items-center justify-center bg-gray-100 p-4">
                        <div className="w-full max-w-md rounded-lg bg-white p-8 shadow-lg text-center">
                            <Clock className="mx-auto h-16 w-16 text-yellow-500 mb-4" />
                            <h2 className="text-2xl font-bold text-gray-800">รอการอนุมัติ</h2>
                            <p className="mt-2 text-gray-600">บัญชี <span className="font-semibold">{user.email}</span> ถูกสร้างเรียบร้อยแล้ว</p>
                            <p className="text-sm text-gray-500 mt-1">กรุณารอผู้ดูแลระบบ (Admin) อนุมัติสิทธิ์การเข้าใช้งาน</p>
                            
                            <div className="mt-6 space-y-3">
                                <div className="bg-yellow-50 border border-yellow-100 rounded p-3 text-xs text-yellow-700">
                                    สถานะ: <strong>Pending Approval</strong><br/>
                                    คุณจะไม่สามารถเข้าใช้งานได้จนกว่าจะได้รับอนุญาต
                                </div>
                                <button onClick={() => signOut(auth)} className="w-full rounded-lg border border-gray-300 py-2 text-gray-600 hover:bg-gray-50 transition">
                                    ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const handleSubmit = async (e) => {
                e.preventDefault();
                setBusy(true);
                setError('');
                try {
                    if (isRegister) {
                        const res = await createUserWithEmailAndPassword(auth, email, password);
                        const isAdmin = email.toLowerCase().includes('admin');
                        await setDoc(getAppDoc('users', res.user.uid), {
                            uid: res.user.uid,
                            email,
                            role: isAdmin ? 'admin' : 'user',
                            approved: !!isAdmin
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (msg.includes('auth/invalid-email')) msg = "รูปแบบอีเมลไม่ถูกต้อง";
                    if (msg.includes('auth/user-not-found') || msg.includes('auth/invalid-credential')) msg = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
                    if (msg.includes('auth/email-already-in-use')) msg = "อีเมลนี้ถูกใช้งานแล้ว";
                    if (msg.includes('auth/weak-password')) msg = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                    setError(msg);
                } finally {
                    setBusy(false);
                }
            };

            return (
                <div className="flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-900 p-4">
                    <div className="w-full max-w-sm rounded-xl bg-white p-8 shadow-2xl">
                        <div className="text-center mb-6">
                            <Book className="mx-auto h-12 w-12 text-blue-600" />
                            <h1 className="mt-2 text-2xl font-bold text-gray-900">ExamOnline</h1>
                            <p className="text-sm text-gray-500">ระบบสอบออนไลน์ครบวงจร</p>
                        </div>

                        {error && (
                            <div className="mb-4 flex items-center rounded bg-red-50 p-3 text-sm text-red-600 animate-fade-in-up">
                                <AlertCircle className="mr-2 h-4 w-4 flex-shrink-0" /> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-medium text-gray-700">อีเมล</label>
                                <input 
                                    type="email" required
                                    className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    placeholder="user@example.com"
                                />
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                                <input 
                                    type="password" required
                                    className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    placeholder="******"
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={busy}
                                className="w-full rounded-md bg-blue-600 py-2 text-white hover:bg-blue-700 disabled:opacity-50 transition"
                            >
                                {busy ? 'กำลังโหลด...' : (isRegister ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ')}
                            </button>
                        </form>
                        
                        <div className="mt-4 text-center text-sm">
                            <button onClick={() => setIsRegister(!isRegister)} className="text-blue-600 hover:underline">
                                {isRegister ? 'มีบัญชีแล้ว? เข้าสู่ระบบ' : 'ยังไม่มีบัญชี? สมัครสมาชิก'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserDashboard({ user, onLogout }) {
            const [tab, setTab] = useState('exam');
            const [isMenuOpen, setIsMenuOpen] = useState(false);

            return (
                <div className="flex min-h-screen flex-col bg-gray-50">
                    <header className="sticky top-0 z-30 bg-white shadow-sm">
                        <div className="mx-auto flex h-16 max-w-7xl items-center justify-between px-4">
                            <div className="flex items-center space-x-2 font-bold text-gray-800 cursor-pointer" onClick={() => setTab('exam')}>
                                <Book className="h-6 w-6 text-blue-600" />
                                <span>ExamOnline</span>
                            </div>
                            
                            <nav className="hidden md:flex space-x-4">
                                <NavBtn active={tab === 'exam'} onClick={() => setTab('exam')} icon={<FileText size={18}/>} label="ทำข้อสอบ" />
                                <NavBtn active={tab === 'history'} onClick={() => setTab('history')} icon={<BarChart2 size={18}/>} label="ผลการสอบ" />
                                <NavBtn active={tab === 'doc'} onClick={() => setTab('doc')} icon={<PlayCircle size={18}/>} label="คลังความรู้" />
                            </nav>

                            <div className="hidden md:flex items-center space-x-3">
                                <span className="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">{user.email}</span>
                                <button onClick={onLogout} className="rounded-full bg-gray-100 p-2 hover:bg-red-50 hover:text-red-600 transition">
                                    <LogOut size={18} />
                                </button>
                            </div>

                            <button className="md:hidden" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                                {isMenuOpen ? <X /> : <Menu />}
                            </button>
                        </div>

                        {isMenuOpen && (
                            <div className="border-t bg-white p-4 md:hidden space-y-2 animate-fade-in-down">
                                <MobileBtn active={tab === 'exam'} onClick={() => {setTab('exam'); setIsMenuOpen(false)}} label="ทำข้อสอบ" />
                                <MobileBtn active={tab === 'history'} onClick={() => {setTab('history'); setIsMenuOpen(false)}} label="ผลการสอบ" />
                                <MobileBtn active={tab === 'doc'} onClick={() => {setTab('doc'); setIsMenuOpen(false)}} label="คลังความรู้" />
                                <div className="border-t pt-2">
                                    <button onClick={onLogout} className="w-full text-left text-red-600 py-2">ออกจากระบบ</button>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="mx-auto w-full max-w-7xl flex-1 p-4 md:p-6">
                        {tab === 'exam' && <ExamListSection user={user} setTab={setTab} />}
                        {tab === 'history' && <HistorySection user={user} />}
                        {tab === 'doc' && <ResourceSection />}
                    </main>
                </div>
            );
        }

        function AdminDashboard({ user, onLogout, onSwitchView }) {
            const [page, setPage] = useState('users');

            return (
                <div className="flex h-screen flex-col md:flex-row bg-gray-100">
                    <aside className="w-full bg-gray-900 text-white md:w-64 flex-shrink-0 flex flex-col">
                        <div className="flex h-16 items-center px-6 font-bold shadow-lg bg-gray-800">
                            <Shield className="mr-2 h-5 w-5 text-blue-400" /> Admin Panel
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
                            <AdminBtn active={page === 'users'} onClick={() => setPage('users')} icon={<Users size={20}/>} label="จัดการผู้ใช้" />
                            <AdminBtn active={page === 'exams'} onClick={() => setPage('exams')} icon={<FileText size={20}/>} label="คลังข้อสอบ" />
                            <AdminBtn active={page === 'content'} onClick={() => setPage('content')} icon={<Upload size={20}/>} label="เนื้อหาเสริม" />
                        </nav>
                        <div className="border-t border-gray-700 p-4 space-y-2">
                            <button onClick={onSwitchView} className="flex w-full items-center rounded px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition">
                                <Home size={16} className="mr-2"/> หน้า User
                            </button>
                            <button onClick={onLogout} className="flex w-full items-center rounded px-4 py-2 text-sm text-red-300 hover:bg-red-900/20 transition">
                                <LogOut size={16} className="mr-2"/> ออกจากระบบ
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-auto p-6">
                        <div className="mx-auto max-w-5xl rounded-lg bg-white p-6 shadow-sm min-h-[500px]">
                            {page === 'users' && <AdminUsersManager />}
                            {page === 'exams' && <AdminExamsManager />}
                            {page === 'content' && <AdminContentManager />}
                        </div>
                    </main>
                </div>
            );
        }

        function FeaturedResourceCard({ item, setTab }) {
            const isVideo = item.type === 'video';
            const icon = isVideo ? <PlayCircle size={20} className="text-red-500" /> : <FileUp size={20} className="text-blue-500" />;
            
            const handleViewClick = () => {
                if(setTab) {
                    setTab('doc'); // Go to resource tab if available
                }
                window.open(item.url, '_blank');
            }

            return (
                <div className="overflow-hidden rounded-xl bg-white shadow-md transition hover:shadow-lg border border-gray-100 h-full flex flex-col">
                    {isVideo && item.url ? (
                        <div className="aspect-video bg-black flex items-center justify-center relative">
                            <iframe 
                                src={getYouTubeEmbedUrl(item.url)} 
                                className="h-full w-full" 
                                title={item.title} 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                allowFullScreen 
                            />
                        </div>
                    ) : (
                        <div className="flex h-32 items-center justify-center bg-blue-50 text-blue-600 group-hover:bg-blue-100 transition">
                            <FileText size={48} />
                        </div>
                    )}
                    <div className="p-4 flex-1 flex flex-col">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center space-x-1">
                                {icon}
                                <span className="text-xs font-medium text-gray-500">{isVideo ? 'วิดีโอ' : 'เอกสาร'}</span>
                            </div>
                            <span className="rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                        </div>
                        <h3 className="font-bold text-gray-900 line-clamp-2 mb-3 flex-1">{item.title}</h3>
                        <a 
                            href={item.url} 
                            target="_blank" 
                            rel="noreferrer" 
                            className="w-full flex items-center justify-center rounded-lg bg-blue-600 py-2 text-sm text-white hover:bg-blue-700 transition mt-auto"
                        >
                            {isVideo ? 'ดูวิดีโอ' : 'ดาวน์โหลดเอกสาร'}
                        </a>
                    </div>
                </div>
            );
        }

        function ExamListSection({ user, setTab }) {
            const [exams, setExams] = useState([]);
            const [docs, setDocs] = useState([]);
            const [videos, setVideos] = useState([]);
            const [loadingData, setLoadingData] = useState(true);
            const [runningExam, setRunningExam] = useState(null);

            const fetchData = async () => {
                setLoadingData(true);
                try {
                    const [examSnap, docSnap, videoSnap] = await Promise.all([
                        getDocs(query(getAppCollection('exams'))),
                        getDocs(query(getAppCollection('documents'))),
                        getDocs(query(getAppCollection('videos'))),
                    ]);

                    setExams(examSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setDocs(docSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'document' })));
                    setVideos(videoSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'video' })));
                } catch (error) {
                    console.error("Error fetching data for dashboard:", error);
                } finally {
                    setLoadingData(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            // คำนวณข้อมูลแนะนำล่วงหน้าเพื่อส่งให้ ExamRunner
            const recentDocs = docs.slice(0, 3).map(d => ({...d, id: d.id + '-doc'}));
            const recentVideos = videos.slice(0, 3).map(v => ({...v, id: v.id + '-vid'}));
            const allResources = [...recentDocs, ...recentVideos];

            if (runningExam) {
                return <ExamRunner exam={runningExam} user={user} onFinish={() => setRunningExam(null)} recentDocs={recentDocs} recentVideos={recentVideos} />;
            }
            
            return (
                <div className="space-y-10">
                    
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">เลือกวิชาสอบ</h2>
                        <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                            {exams.map(e => (
                                <div key={e.id} className="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm transition hover:shadow-md border border-gray-100">
                                    <div className="mb-4 flex items-center justify-between">
                                        <span className="rounded bg-blue-100 px-2 py-1 text-xs font-bold text-blue-700">{e.timeLimit} นาที</span>
                                        <FileText className="h-6 w-6 text-gray-300 group-hover:text-blue-500" />
                                    </div>
                                    <h3 className="mb-2 text-lg font-bold text-gray-900">{e.title}</h3>
                                    <p className="mb-4 text-sm text-gray-500 line-clamp-2">{e.description || "ไม่มีรายละเอียด"}</p>
                                    <button 
                                        onClick={() => setRunningExam(e)}
                                        className="w-full rounded-lg bg-blue-600 py-2 text-sm font-medium text-white hover:bg-blue-700 transition"
                                    >
                                        เริ่มทำข้อสอบ
                                    </button>
                                </div>
                            ))}
                            {exams.length === 0 && (
                                <div className="col-span-full flex flex-col items-center justify-center py-16 bg-white rounded-xl border border-dashed border-gray-300">
                                    <FileText className="w-16 h-16 text-gray-300 mb-4" />
                                    <p className="text-gray-500">ยังไม่มีข้อสอบในระบบ</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {loadingData && (
                         <div className="text-center py-10 text-gray-500 flex items-center justify-center">
                            <Clock className="w-4 h-4 mr-2 animate-spin"/> กำลังโหลดข้อมูลแนะนำ...
                         </div>
                    )}

                    {!loadingData && (recentDocs.length > 0 || recentVideos.length > 0) && (
                        <div className="border-t pt-6 border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center mb-6">
                                <PlayCircle className="w-6 h-6 mr-2 text-blue-600"/> คลังความรู้แนะนำ
                            </h2>
                            
                            {/* ส่วนแสดงเอกสาร */}
                            {recentDocs.length > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารล่าสุด
                                    </h3>
                                    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                        {recentDocs.map((item) => (
                                            <FeaturedResourceCard key={item.id} item={item} setTab={setTab} />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* ส่วนแสดงวิดีโอ */}
                            {recentVideos.length > 0 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอล่าสุด
                                    </h3>
                                    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                        {recentVideos.map((item) => (
                                            <FeaturedResourceCard key={item.id} item={item} setTab={setTab} />
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {allResources.length > 0 && (
                                 <div className="text-right mt-6">
                                     <button 
                                        onClick={() => setTab('doc')}
                                        className="rounded-full bg-blue-50 px-4 py-2 text-sm text-blue-600 font-medium hover:bg-blue-100 transition flex items-center justify-end ml-auto w-fit"
                                    >
                                        ดูเนื้อหาทั้งหมด <FileText className="w-4 h-4 ml-1" />
                                    </button>
                                 </div>
                            )}
                        </div>
                    )}

                </div>
            );
        }

        function ExamRunner({ exam, user, onFinish, recentDocs, recentVideos }) {
            const [idx, setIdx] = useState(0);
            const [ans, setAns] = useState({});
            const [timer, setTimer] = useState(exam.timeLimit * 60);
            const [done, setDone] = useState(false);
            const [score, setScore] = useState(0);

            useEffect(() => {
                if (done) return;
                const interval = setInterval(() => {
                    setTimer(t => {
                        if (t <= 1) {
                            handleSubmit();
                            return 0;
                        }
                        return t - 1;
                    });
                }, 1000);
                return () => clearInterval(interval);
            }, [done]);

            const handleSubmit = async () => {
                let s = 0;
                exam.questions.forEach((q, i) => {
                    if (ans[i] === q.correctAnswer) s++;
                });
                setScore(s);
                setDone(true);
                
                await addDoc(getAppCollection('scores'), {
                    userId: user.uid,
                    examId: exam.id,
                    examTitle: exam.title,
                    score: s,
                    totalQuestions: exam.questions.length,
                    timestamp: serverTimestamp()
                });
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${String(s).padStart(2, '0')}`;
            };

            // Helper to render recommended resources inside exam/result page
            const RecommendedResourcesSection = () => (
                <div className="mt-12 border-t pt-8">
                     <h3 className="text-xl font-bold text-gray-800 flex items-center mb-6">
                        <PlayCircle className="w-6 h-6 mr-2 text-blue-600"/> คลังความรู้แนะนำ
                    </h3>
                    
                    {recentDocs && recentDocs.length > 0 && (
                        <div className="mb-8">
                            <h4 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารล่าสุด
                            </h4>
                            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                {recentDocs.map((item) => (
                                    <FeaturedResourceCard key={item.id} item={item} />
                                ))}
                            </div>
                        </div>
                    )}

                    {recentVideos && recentVideos.length > 0 && (
                        <div>
                            <h4 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอล่าสุด
                            </h4>
                            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                {recentVideos.map((item) => (
                                    <FeaturedResourceCard key={item.id} item={item} />
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );

            if (done) {
                const percentage = Math.round((score / exam.questions.length) * 100);
                return (
                    <div className="mx-auto max-w-3xl">
                        <div className="rounded-xl bg-white p-8 shadow text-center animate-fade-in-up mb-8">
                            {percentage >= 50 ? 
                                <Award className="mx-auto h-20 w-20 text-yellow-400 mb-4 animate-bounce" /> :
                                <div className="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4"><X className="text-red-500 w-10 h-10"/></div>
                            }
                            <h2 className="text-3xl font-bold mb-2 text-gray-800">ส่งคำตอบเรียบร้อย</h2>
                            <p className="text-gray-500 mb-8">{exam.title}</p>
                            <div className="grid grid-cols-3 gap-4 mb-8">
                                <div className="p-3 bg-blue-50 rounded-lg">
                                    <div className="text-2xl font-bold text-blue-600">{score}</div>
                                    <div className="text-xs text-gray-500">คะแนน</div>
                                </div>
                                <div className="p-3 bg-gray-50 rounded-lg">
                                    <div className="text-2xl font-bold text-gray-700">{exam.questions.length}</div>
                                    <div className="text-xs text-gray-500">เต็ม</div>
                                </div>
                                <div className={`p-3 rounded-lg ${percentage >= 50 ? 'bg-green-50' : 'bg-red-50'}`}>
                                    <div className={`text-2xl font-bold ${percentage >= 50 ? 'text-green-600' : 'text-red-600'}`}>{percentage}%</div>
                                    <div className="text-xs text-gray-500">ผลลัพธ์</div>
                                </div>
                            </div>
                            
                            <div className="mt-10 text-left border-t pt-6">
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><CheckCircle className="w-5 h-5 mr-2 text-green-600"/> เฉลยละเอียด</h3>
                                <div className="space-y-6">
                                    {exam.questions.map((q, i) => {
                                        const isCorrect = ans[i] === q.correctAnswer;
                                        return (
                                            <div key={i} className={`p-4 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                <div className="flex items-start mb-2">
                                                    <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold mr-2 text-white ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`}>
                                                        {i + 1}
                                                    </span>
                                                    <span className="font-medium text-gray-900">{q.text}</span>
                                                </div>
                                                <div className="ml-8 text-sm space-y-1">
                                                    <div className="flex items-center">
                                                        <span className="w-24 text-gray-500">คำตอบของคุณ:</span>
                                                        <span className={`font-bold ${isCorrect ? 'text-green-700' : 'text-red-600'}`}>
                                                            {q.options[ans[i]] !== undefined ? q.options[ans[i]] : '(ไม่ได้ตอบ)'}
                                                        </span>
                                                    </div>
                                                    {!isCorrect && (
                                                        <div className="flex items-center">
                                                            <span className="w-24 text-gray-500">เฉลยถูกต้อง:</span>
                                                            <span className="font-bold text-green-700">{q.options[q.correctAnswer]}</span>
                                                        </div>
                                                    )}
                                                    {q.explanation && (
                                                        <div className="mt-2 pt-2 border-t border-gray-200 text-sm text-gray-600">
                                                            <span className="font-semibold">คำอธิบาย:</span> {q.explanation}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="mt-8">
                                <button onClick={onFinish} className="rounded-lg bg-gray-800 px-6 py-2 text-white hover:bg-gray-900 transition">กลับหน้าหลัก</button>
                            </div>
                        </div>
                        
                        {/* แสดงเอกสารแนะนำท้ายผลสอบ */}
                        <RecommendedResourcesSection />
                    </div>
                );
            }

            const q = exam.questions[idx];
            return (
                <div className="mx-auto max-w-3xl pb-12">
                    <div className="mb-4 flex justify-between items-center bg-white p-4 rounded shadow-sm">
                        <span className="font-bold text-gray-700">ข้อที่ {idx + 1} / {exam.questions.length}</span>
                        <span className={`font-mono font-bold px-3 py-1 rounded ${timer < 60 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-blue-50 text-blue-600'}`}>
                            <Clock className="inline w-4 h-4 mr-1 mb-0.5"/> {formatTime(timer)}
                        </span>
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow-sm mb-6">
                        <div className="h-2 bg-gray-100 rounded-full mb-6">
                             <div className="h-full bg-blue-500 rounded-full transition-all duration-300" style={{ width: `${((idx + 1) / exam.questions.length) * 100}%` }}></div>
                        </div>
                        <p className="text-lg font-medium mb-6 text-gray-900">{q.text}</p>
                        <div className="space-y-3">
                            {q.options.map((opt, i) => (
                                <button
                                    key={i}
                                    onClick={() => setAns({ ...ans, [idx]: i })}
                                    className={`flex w-full items-center rounded-lg border p-4 text-left transition group ${
                                        ans[idx] === i ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500 text-blue-800' : 'border-gray-200 hover:bg-gray-50'
                                    }`}
                                >
                                    <div className={`mr-3 flex h-8 w-8 items-center justify-center rounded-full border font-bold text-sm transition ${ans[idx] === i ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-500 bg-white group-hover:bg-blue-50'}`}>
                                        {['A','B','C','D'][i]}
                                    </div>
                                    <span className="text-base">{opt}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex justify-between mb-10">
                        <button disabled={idx === 0} onClick={() => setIdx(idx - 1)} className="rounded-lg bg-gray-200 px-6 py-2.5 disabled:opacity-50 font-medium text-gray-600 hover:bg-gray-300 transition">ย้อนกลับ</button>
                        {idx === exam.questions.length - 1 ? (
                            <button onClick={handleSubmit} className="rounded-lg bg-green-600 px-8 py-2.5 text-white hover:bg-green-700 font-bold shadow-lg transition transform hover:-translate-y-0.5">ส่งคำตอบ</button>
                        ) : (
                            <button onClick={() => setIdx(idx + 1)} className="rounded-lg bg-blue-600 px-8 py-2.5 text-white hover:bg-blue-700 font-bold shadow-lg transition transform hover:-translate-y-0.5">ถัดไป</button>
                        )}
                    </div>
                    
                    {/* แสดงเอกสารแนะนำระหว่างทำข้อสอบ */}
                    <div className="bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <div className="text-sm text-gray-500 mb-2 flex items-center">
                            <Book className="w-4 h-4 mr-1"/> แนะนำ: สามารถศึกษาข้อมูลเพิ่มเติมได้
                        </div>
                        <RecommendedResourcesSection />
                    </div>
                </div>
            );
        }

        function HistorySection({ user }) {
            const [logs, setLogs] = useState([]);
            useEffect(() => {
                // NOTE: Modified query to remove orderBy to avoid "Missing or insufficient permissions" / Index errors
                // Firestore requires a composite index for where + orderBy on different fields.
                // We fetch only by userId and sort in memory.
                const q = query(getAppCollection('scores'), where('userId', '==', user.uid));
                
                getDocs(q).then(s => {
                    const data = s.docs.map(d => d.data());
                    // Sort in-memory: Newest first (descending)
                    data.sort((a, b) => {
                         // Handle serverTimestamp being null immediately after write by using 0 or current time
                        const timeA = a.timestamp ? a.timestamp.seconds : Date.now() / 1000;
                        const timeB = b.timestamp ? b.timestamp.seconds : Date.now() / 1000;
                        return timeB - timeA;
                    });
                    setLogs(data);
                });
            }, [user]);

            return (
                <div className="rounded-lg bg-white shadow-sm overflow-hidden">
                    <div className="border-b px-6 py-4 bg-gray-50">
                        <h2 className="text-lg font-bold text-gray-800">ประวัติการสอบ</h2>
                    </div>
                    <div className="divide-y">
                        {logs.map((l, i) => (
                            <div key={i} className="flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition">
                                <div>
                                    <p className="font-bold text-gray-900">{l.examTitle}</p>
                                    <p className="text-xs text-gray-500 flex items-center mt-1">
                                        <Clock className="w-3 h-3 mr-1"/> 
                                        {l.timestamp ? l.timestamp.toDate().toLocaleString('th-TH') : 'กำลังบันทึก...'}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <span className="block text-lg font-bold text-blue-600">{l.score} / {l.totalQuestions}</span>
                                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${l.score/l.totalQuestions >= 0.5 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {l.score/l.totalQuestions >= 0.5 ? 'ผ่านเกณฑ์' : 'ไม่ผ่าน'}
                                    </span>
                                </div>
                            </div>
                        ))}
                        {logs.length === 0 && <div className="p-8 text-center text-gray-500">ไม่มีประวัติการสอบ</div>}
                    </div>
                </div>
            );
        }

        function ResourceSection() {
            const [docs, setDocs] = useState([]);
            const [videos, setVideos] = useState([]);

            useEffect(() => {
                Promise.all([getDocs(getAppCollection('documents')), getDocs(getAppCollection('videos'))])
                    .then(([d, v]) => {
                        setDocs(d.docs.map(x => ({...x.data(), id: x.id, type: 'document'})));
                        setVideos(v.docs.map(x => ({...x.data(), id: x.id, type: 'video'})));
                    });
            }, []);

            return (
                <div>
                    <h2 className="mb-6 text-2xl font-bold text-gray-800">คลังความรู้</h2>
                    
                    {/* ส่วนเอกสารทั้งหมด */}
                    <div className="mb-10">
                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                             <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารทั้งหมด
                        </h3>
                        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            {docs.map((item, i) => (
                                <div key={i} className="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-100 hover:shadow-md transition group">
                                    <div className="flex h-32 items-center justify-center bg-blue-50 text-blue-600 group-hover:bg-blue-100 transition">
                                        <FileText size={48} />
                                    </div>
                                    <div className="p-4">
                                        <div className="mb-2">
                                            <span className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                                        </div>
                                        <h3 className="font-bold text-gray-900 line-clamp-1">{item.title}</h3>
                                        <a href={item.url} target="_blank" rel="noreferrer" className="mt-3 flex items-center justify-center w-full rounded border border-blue-200 py-2 text-center text-sm text-blue-600 hover:bg-blue-600 hover:text-white transition">
                                            <Upload className="w-4 h-4 mr-2 transform rotate-180"/> ดาวน์โหลด
                                        </a>
                                    </div>
                                </div>
                            ))}
                            {docs.length === 0 && <div className="col-span-full text-center py-6 text-gray-400">ไม่มีเอกสาร</div>}
                        </div>
                    </div>

                    {/* ส่วนวิดีโอทั้งหมด */}
                    <div>
                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                            <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอทั้งหมด
                        </h3>
                        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            {videos.map((item, i) => (
                                <div key={i} className="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-100 hover:shadow-md transition group">
                                    <div className="aspect-video bg-black">
                                        <iframe 
                                            src={getYouTubeEmbedUrl(item.url)} 
                                            className="h-full w-full" 
                                            title={item.title} 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                            allowFullScreen 
                                        />
                                    </div>
                                    <div className="p-4">
                                        <div className="mb-2">
                                            <span className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                                        </div>
                                        <h3 className="font-bold text-gray-900 line-clamp-1">{item.title}</h3>
                                    </div>
                                </div>
                            ))}
                            {videos.length === 0 && <div className="col-span-full text-center py-6 text-gray-400">ไม่มีวิดีโอ</div>}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Admin Managers ---

        function AdminUsersManager() {
            const [users, setUsers] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', data: null });
            
            const reload = () => getDocs(getAppCollection('users')).then(s => setUsers(s.docs.map(d => d.data())));
            useEffect(() => { reload(); }, []);

            const handleAction = (type, user) => {
                setModalConfig({ isOpen: true, type, data: user });
            };
            
            const confirmAction = async () => {
                const { type, data } = modalConfig;
                if (type === 'approve') {
                    await updateDoc(getAppDoc('users', data.uid), { approved: !data.approved });
                } else if (type === 'role') {
                    const newRole = data.role === 'admin' ? 'user' : 'admin';
                    await updateDoc(getAppDoc('users', data.uid), { role: newRole });
                }
                reload();
            };

            return (
                <div>
                    <h3 className="mb-4 text-xl font-bold">รายชื่อผู้ใช้งาน ({users.length})</h3>
                    <div className="overflow-hidden rounded border shadow-sm">
                        <table className="min-w-full divide-y bg-white">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Email</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Role</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {users.map(u => (
                                    <tr key={u.uid} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 text-sm">{u.email}</td>
                                        <td className="px-4 py-3 text-sm">
                                            <span className={`rounded px-2 py-0.5 text-xs font-bold uppercase ${u.role==='admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`}>{u.role}</span>
                                        </td>
                                        <td className="px-4 py-3 text-sm">{u.approved ? <span className="text-green-600 font-medium flex items-center"><CheckCircle className="w-3 h-3 mr-1"/> Active</span> : <span className="text-yellow-600 font-medium flex items-center"><Clock className="w-3 h-3 mr-1"/> Pending</span>}</td>
                                        <td className="px-4 py-3 text-sm space-x-2">
                                            <button onClick={() => handleAction('approve', u)} className={`text-xs font-medium px-2 py-1 rounded border ${u.approved ? 'text-red-500 border-red-200 hover:bg-red-50' : 'text-green-600 border-green-200 hover:bg-green-50'}`}>
                                                {u.approved ? 'ระงับ' : 'อนุมัติ'}
                                            </button>
                                            <button onClick={() => handleAction('role', u)} className="text-xs font-medium px-2 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-100" title="เปลี่ยนสิทธิ์">
                                                {u.role === 'admin' ? <UserX className="w-3 h-3"/> : <UserCheck className="w-3 h-3"/>}
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <ConfirmationModal 
                        isOpen={modalConfig.isOpen}
                        onClose={() => setModalConfig({...modalConfig, isOpen: false})}
                        onConfirm={confirmAction}
                        title={modalConfig.type === 'approve' ? (modalConfig.data?.approved ? "ยืนยันการระงับผู้ใช้" : "ยืนยันการอนุมัติผู้ใช้") : "ยืนยันการเปลี่ยนสิทธิ์"}
                        message={modalConfig.type === 'approve' 
                            ? `คุณต้องการ${modalConfig.data?.approved ? 'ระงับ' : 'อนุมัติ'}ผู้ใช้ ${modalConfig.data?.email} ใช่หรือไม่?`
                            : `คุณต้องการเปลี่ยนสิทธิ์ผู้ใช้ ${modalConfig.data?.email} เป็น ${modalConfig.data?.role === 'admin' ? 'User' : 'Admin'} ใช่หรือไม่?`
                        }
                        confirmColor={modalConfig.type === 'approve' && modalConfig.data?.approved ? "bg-red-600 hover:bg-red-700" : "bg-green-600 hover:bg-green-700"}
                    />
                </div>
            );
        }

        function AdminExamsManager() {
            const [exams, setExams] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            const [title, setTitle] = useState('');
            const [limit, setLimit] = useState(30);
            const [csv, setCsv] = useState('');
            const [error, setError] = useState('');
            const [deleteId, setDeleteId] = useState(null);
            const fileInputRef = useRef(null);

            const reload = () => getDocs(getAppCollection('exams')).then(s => setExams(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            useEffect(() => { reload(); }, []);

            const handleCreate = async () => {
                setError('');
                if (!title || !csv) {
                    setError('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }
                
                // CSV Parsing Logic
                const questions = csv.split('\n')
                    .filter(x => x.trim())
                    .map((line, index) => {
                        // Skip header if present (simple check: if first line has 'question')
                        if (index === 0 && line.toLowerCase().startsWith('question')) return null;

                        // Handle CSV parsing more robustly (splitting by comma, but acknowledging simple structure)
                        const parts = line.split(',');
                        const trimmedParts = parts.map(p => p.trim());
                        
                        // Format: question,choice1,choice2,choice3,choice4,answer,explanation
                        // Length should be at least 6 (question + 4 choices + answer). Explanation is optional but preferred.
                        if (trimmedParts.length < 6) return null;

                        const q = { 
                            text: trimmedParts[0], 
                            options: [trimmedParts[1], trimmedParts[2], trimmedParts[3], trimmedParts[4]], 
                            correctAnswer: parseInt(trimmedParts[5]) - 1 
                        };

                        // Add explanation if available (index 6)
                        if (trimmedParts[6]) {
                            q.explanation = trimmedParts[6];
                        }
                        return q;
                    })
                    .filter(q => q !== null); // Filter out nulls (header or invalid lines)
                
                if (questions.length === 0) {
                    setError('ไม่พบข้อมูลคำถาม หรือรูปแบบ CSV ไม่ถูกต้อง');
                    return;
                }

                if (questions.some(q => !q.text || q.options.length < 4 || isNaN(q.correctAnswer) || q.correctAnswer < 0 || q.correctAnswer > 3)) {
                    setError('รูปแบบ CSV บางบรรทัดไม่ถูกต้อง (โจทย์,ก,ข,ค,ง,เลขคำตอบ 1-4,คำอธิบาย)');
                    return;
                }
                
                await addDoc(getAppCollection('exams'), { title, timeLimit: limit, questions, description: 'สร้างโดย Admin' });
                setIsOpen(false); setTitle(''); setCsv(''); reload();
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        setCsv(evt.target.result);
                    };
                    reader.readAsText(file);
                }
            };

            const handleDelete = async () => {
                if (deleteId) {
                   await deleteDoc(getAppDoc('exams', deleteId)); 
                   reload();
                }
            };

            return (
                <div>
                    <div className="mb-4 flex items-center justify-between">
                        <h3 className="text-xl font-bold">จัดการข้อสอบ</h3>
                        <button onClick={() => setIsOpen(true)} className="rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700 transition flex items-center"><Plus className="w-4 h-4 mr-1"/> เพิ่มข้อสอบ</button>
                    </div>

                    {isOpen && (
                        <div className="mb-6 rounded-lg bg-blue-50 p-6 border border-blue-100 shadow-sm animate-fade-in-up">
                            <h4 className="font-bold text-blue-800 mb-4">เพิ่มข้อสอบใหม่</h4>
                            {error && <div className="mb-4 text-sm text-red-600 bg-red-100 border border-red-200 rounded p-2">{error}</div>}
                            <div className="mb-3 grid gap-3 sm:grid-cols-2">
                                <input className="rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ชื่อวิชา" value={title} onChange={e => setTitle(e.target.value)} />
                                <input className="rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" type="number" placeholder="เวลา (นาที)" value={limit} onChange={e => setLimit(Number(e.target.value))} />
                            </div>
                            <div className="mb-3">
                                <label className="block text-sm font-medium text-gray-700 mb-1">นำเข้าไฟล์ CSV (Import File)</label>
                                <div className="flex items-center gap-2 mb-2">
                                    <input 
                                        type="file" 
                                        accept=".csv" 
                                        onChange={handleFileUpload}
                                        ref={fileInputRef}
                                        className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"
                                    />
                                </div>
                                <div className="text-xs text-gray-500 mb-1 p-2 bg-white rounded border">
                                    <strong>Format:</strong> question,choice1,choice2,choice3,choice4,answer,explanation<br/>
                                    <strong>Example:</strong> 1+1=?,1,2,3,4,2,เพราะ 1 บวก 1 ได้ 2
                                </div>
                                <textarea className="w-full rounded border p-2 h-32 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="วางข้อมูล CSV ที่นี่..." value={csv} onChange={e => setCsv(e.target.value)} />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleCreate} className="rounded bg-green-600 px-6 py-2 text-sm text-white font-medium hover:bg-green-700 transition">บันทึก</button>
                                <button onClick={() => setIsOpen(false)} className="rounded bg-gray-300 px-4 py-2 text-sm font-medium hover:bg-gray-400 transition">ยกเลิก</button>
                            </div>
                        </div>
                    )}

                    <div className="space-y-2">
                        {exams.map(e => (
                            <div key={e.id} className="flex items-center justify-between rounded border bg-white p-4 shadow-sm hover:border-blue-300 transition">
                                <div>
                                    <span className="font-bold text-gray-800 text-lg">{e.title}</span>
                                    <span className="ml-3 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">({e.questions?.length || 0} ข้อ / {e.timeLimit} นาที)</span>
                                </div>
                                <button onClick={() => setDeleteId(e.id)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition"><Trash2 size={18}/></button>
                            </div>
                        ))}
                    </div>
                    
                    <ConfirmationModal 
                        isOpen={!!deleteId} 
                        onClose={() => setDeleteId(null)} 
                        onConfirm={handleDelete} 
                        title="ยืนยันการลบ" 
                        message="คุณต้องการลบข้อสอบชุดนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้" 
                        confirmText="ลบข้อสอบ"
                        confirmColor="bg-red-600 hover:bg-red-700"
                    />
                </div>
            );
        }

        function AdminContentManager() {
            const [items, setItems] = useState([]);
            const [form, setForm] = useState({ title: '', url: '', category: '', type: 'document' });
            const [deleteItem, setDeleteItem] = useState(null);

            const reload = () => {
                Promise.all([getDocs(getAppCollection('documents')), getDocs(getAppCollection('videos'))]).then(([d, v]) => {
                    setItems([...d.docs.map(x => ({id: x.id, ...x.data(), type: 'document'})), ...v.docs.map(x => ({id: x.id, ...x.data(), type: 'video'}))]);
                });
            };
            useEffect(() => { reload(); }, []);

            const handleAdd = async () => {
                if (!form.title || !form.url) return;
                await addDoc(getAppCollection(form.type === 'document' ? 'documents' : 'videos'), { 
                    title: form.title, url: form.url, category: form.category, type: form.type 
                });
                setForm({ title: '', url: '', category: '', type: 'document' });
                reload();
            };

            const handleDelete = async () => {
                if(deleteItem) {
                   await deleteDoc(getAppDoc(deleteItem.type === 'document' ? 'documents' : 'videos', deleteItem.id));
                   reload();
                }
            };

            return (
                <div>
                    <h3 className="mb-4 text-xl font-bold">เนื้อหาเสริม</h3>
                    <div className="mb-6 grid gap-2 rounded bg-gray-50 p-4 border md:grid-cols-4">
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="ชื่อเรื่อง" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="URL (Link)" value={form.url} onChange={e => setForm({...form, url: e.target.value})} />
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="หมวดหมู่" value={form.category} onChange={e => setForm({...form, category: e.target.value})} />
                        <select className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                            <option value="document">เอกสาร</option>
                            <option value="video">วิดีโอ</option>
                        </select>
                        <button onClick={handleAdd} className="md:col-span-4 rounded bg-blue-600 py-2 text-white hover:bg-blue-700 font-medium transition">เพิ่มรายการ</button>
                    </div>

                    <div className="space-y-2">
                        {items.map(item => (
                            <div key={item.id} className="flex items-center justify-between rounded border bg-white p-3 hover:shadow-sm transition">
                                <div className="flex items-center gap-3">
                                    {item.type === 'video' ? <PlayCircle size={20} className="text-red-500"/> : <FileText size={20} className="text-blue-500"/>}
                                    <span className="font-medium">{item.title}</span>
                                    <a href={item.url} target="_blank" className="text-xs text-blue-400 hover:underline truncate max-w-[200px]">{item.url}</a>
                                </div>
                                <button onClick={() => setDeleteItem(item)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={18}/></button>
                            </div>
                        ))}
                    </div>
                    
                    <ConfirmationModal 
                        isOpen={!!deleteItem} 
                        onClose={() => setDeleteItem(null)} 
                        onConfirm={handleDelete} 
                        title="ยืนยันการลบ" 
                        message={`คุณต้องการลบรายการ "${deleteItem?.title}" ใช่หรือไม่?`}
                        confirmText="ลบรายการ"
                        confirmColor="bg-red-600 hover:bg-red-700"
                    />
                </div>
            );
        }

        // --- Utility Components ---
        function NavBtn({ active, onClick, icon, label }) {
            return <button onClick={onClick} className={`flex items-center space-x-2 rounded-lg px-3 py-2 text-sm font-medium transition ${active ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100'}`}>{icon}<span>{label}</span></button>;
        }
        function MobileBtn({ active, onClick, label }) {
            return <button onClick={onClick} className={`block w-full rounded-md px-3 py-2 text-left font-medium ${active ? 'bg-blue-50 text-blue-600' : 'text-gray-700 hover:bg-gray-50'}`}>{label}</button>;
        }
        function AdminBtn({ active, onClick, icon, label }) {
            return <button onClick={onClick} className={`flex w-full items-center space-x-3 rounded-lg px-3 py-2 transition ${active ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}>{icon}<span>{label}</span></button>;
        }

        // Mount App
        const root = createRoot(document.getElementById('root'));
        root.render(<ExamApp />);
    </script>
</body>
</html>
