<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamOnline - ระบบสอบออนไลน์</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Prompt for Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX translation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        
        // Import Lucide Icons
        // Added 'Image' and 'Network' for Infographic and Mind Map
        import { 
            Book, PlayCircle, FileText, LogOut, User, Users, 
            CheckCircle, Clock, Award, BarChart2, Upload, Trash2, 
            Plus, Menu, X, AlertCircle, Unlock, Shield, Home, UserCheck, UserX, FileUp, Video, HelpCircle, Edit, Save, Eye, EyeOff, ExternalLink,
            CheckSquare, PieChart, TrendingUp, Activity, Link, Minimize2, Maximize2, Columns, Layout, Presentation, FileBox, Image, Network
        } from 'lucide-react';

        // Import Firebase from Google CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, 
            deleteDoc, query, where, orderBy, setDoc, getDoc, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- 1. Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAUraFookA86wCxmR6KBRba5bvncFZHTUw",
            authDomain: "jastin-82769.firebaseapp.com",
            databaseURL: "https://jastin-82769-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jastin-82769",
            storageBucket: "jastin-82769.firebasestorage.app",
            messagingSenderId: "95091235116",
            appId: "1:95091235116:web:b230db5f3d0112ac1cb489",
            measurementId: "G-EEV77J3922"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Helper Functions for Strict Firestore Paths ---
        const getAppCollection = (collectionName) => {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        };

        const getAppDoc = (collectionName, docId) => {
            return doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId);
        };

        // --- CSV Parsing Utilities ---
        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentCell.trim());
                    if (currentRow.length > 0 && (currentRow.length > 1 || currentRow[0] !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell) currentRow.push(currentCell.trim());
            if (currentRow.length > 0) rows.push(currentRow);
            return rows;
        };

        const convertCSVToQuestions = (rows) => {
            if (rows.length === 0) return [];
            
            // 1. Detect Headers
            const headerRow = rows[0].map(c => c.toLowerCase().replace(/[\ufeff\s]/g, '')); // Remove BOM and spaces
            let idx = { q: 0, ops: [1, 2, 3, 4], ans: 5, exp: 6 }; // Default

            // Try to find columns by keywords
            const findIdx = (keywords) => headerRow.findIndex(h => keywords.some(k => h.includes(k)));
            
            const qIdx = findIdx(['question', 'โจทย์', 'text', 'problem']);
            const ansIdx = findIdx(['answer', 'correct', 'เฉลย', 'ans']);
            const expIdx = findIdx(['explain', 'explanation', 'อธิบาย', 'เหตุผล']);
            
            // Heuristic for choices: look for choice1, opt1, a, b, c, d
            const choiceIndices = [];
            ['1', '2', '3', '4'].forEach(n => {
                let i = findIdx(['choice'+n, 'opt'+n, 'ตัวเลือก'+n]);
                if (i === -1 && ['a','b','c','d'].length >= parseInt(n)) i = findIdx([['a','b','c','d'][parseInt(n)-1]]); // fallback matching a,b,c,d columns
                if (i !== -1) choiceIndices.push(i);
            });

            // If headers found, update indices and skip first row
            let startRow = 0;
            if (qIdx !== -1 && ansIdx !== -1) {
                idx.q = qIdx;
                idx.ans = ansIdx;
                if (expIdx !== -1) idx.exp = expIdx;
                if (choiceIndices.length === 4) idx.ops = choiceIndices;
                startRow = 1;
            }

            const questions = [];
            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 3) continue; // Skip malformed rows

                const text = row[idx.q] || '';
                const options = idx.ops.map(oi => row[oi] || '');
                let rawAns = row[idx.ans] || '';
                let correctAnswer = 0;

                // Flexible Answer Parsing
                rawAns = String(rawAns).trim().toLowerCase();
                if (['1', 'a', 'ก'].includes(rawAns)) correctAnswer = 0;
                else if (['2', 'b', 'ข'].includes(rawAns)) correctAnswer = 1;
                else if (['3', 'c', 'ค'].includes(rawAns)) correctAnswer = 2;
                else if (['4', 'd', 'ง'].includes(rawAns)) correctAnswer = 3;
                else {
                    // Try to match text content
                    const matchIdx = options.findIndex(o => o.trim().toLowerCase() === rawAns);
                    if (matchIdx !== -1) correctAnswer = matchIdx;
                    else correctAnswer = parseInt(rawAns) - 1 || 0;
                }
                
                // Ensure valid range
                if (correctAnswer < 0 || correctAnswer > 3) correctAnswer = 0;

                questions.push({
                    text,
                    options,
                    correctAnswer,
                    explanation: row[idx.exp] || ''
                });
            }
            return questions;
        };

        // --- Utility Components ---
        
        function ConfirmationModal({ isOpen, onClose, onConfirm, title, message, confirmText = "ยืนยัน", confirmColor = "bg-blue-600 hover:bg-blue-700" }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm">
                    <div className="w-full max-w-sm overflow-hidden rounded-xl bg-white shadow-2xl animate-fade-in-up">
                        <div className="p-6">
                            <h3 className="mb-2 text-lg font-bold text-gray-900">{title}</h3>
                            <p className="text-gray-600">{message}</p>
                        </div>
                        <div className="flex justify-end gap-3 bg-gray-50 px-6 py-4">
                            <button onClick={onClose} className="rounded-lg px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-200 transition">ยกเลิก</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className={`rounded-lg px-4 py-2 text-sm font-medium text-white transition shadow ${confirmColor}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ฟังก์ชันจัดการลิงก์ YouTube
        const getYouTubeEmbedUrl = (url) => {
            let videoId = '';
            const match = url.match(/(?:v=|\/embed\/|\/v\/|youtu\.be\/|\/watch\?v=)([^#\&\?]*).*/);
            if (match && match[1]) {
                videoId = match[1];
            }
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}`;
            }
            return url;
        };

        // ฟังก์ชันจัดการลิงก์เอกสาร (รองรับ Google Drive/Docs)
        const getDocumentEmbedUrl = (url) => {
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) {
                    const fileId = idMatch[1];
                    if (url.includes('/document/') || url.includes('/presentation/') || url.includes('/spreadsheets/')) {
                         if (url.includes('/document/')) return `https://docs.google.com/document/d/${fileId}/preview`;
                         if (url.includes('/presentation/')) return `https://docs.google.com/presentation/d/${fileId}/preview`;
                         if (url.includes('/spreadsheets/')) return `https://docs.google.com/spreadsheets/d/${fileId}/preview`;
                    }
                    return `https://drive.google.com/file/d/${fileId}/preview`;
                }
            }
            return `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        };

        function DocumentPreviewModal({ item, onClose }) {
            if (!item) return null;
            const isVideo = item.type === 'video';
            
            let embedUrl = '';
            if (isVideo) {
                embedUrl = getYouTubeEmbedUrl(item.url);
            } else {
                embedUrl = getDocumentEmbedUrl(item.url);
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm animate-fade-in-up">
                    <div className="relative h-full w-full max-w-6xl overflow-hidden rounded-xl bg-white shadow-2xl flex flex-col">
                        <div className="flex items-center justify-between border-b bg-gray-50 px-4 py-3">
                            <div className="flex items-center gap-2 overflow-hidden">
                                {isVideo ? <Video size={20} className="text-red-500"/> : <FileText size={20} className="text-blue-500"/>}
                                <h3 className="text-lg font-bold text-gray-800 truncate max-w-md md:max-w-xl">{item.title}</h3>
                            </div>
                            <button onClick={onClose} className="rounded-full p-1.5 hover:bg-gray-200 transition text-gray-500 hover:text-gray-800">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="flex-1 bg-gray-100 relative overflow-hidden">
                             <div className="absolute inset-0 flex items-center justify-center z-0">
                                <div className="flex flex-col items-center text-gray-400">
                                    <Clock className="w-8 h-8 mb-2 animate-spin"/>
                                    <span>กำลังโหลดตัวอย่าง...</span>
                                </div>
                             </div>
                             <iframe 
                                src={embedUrl} 
                                className="h-full w-full relative z-10 bg-white" 
                                title="Preview"
                                frameBorder="0"
                                allowFullScreen
                            />
                        </div>
                        <div className="bg-white p-4 border-t flex justify-between items-center">
                             <span className="text-sm text-gray-500 hidden md:inline">
                                {isVideo ? 'วิดีโอจาก YouTube' : (embedUrl.includes('docs.google.com') || embedUrl.includes('drive.google.com') ? 'ตัวอย่างเอกสารผ่าน Google Drive' : 'ตัวอย่างเอกสาร')}
                             </span>
                             <div className="flex gap-2">
                                 <button onClick={onClose} className="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                                    ปิด
                                 </button>
                                 <a href={item.url} target="_blank" rel="noreferrer" className="flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 transition shadow">
                                    <ExternalLink className="mr-2 h-4 w-4"/> {isVideo ? 'เปิดใน YouTube' : 'ดาวน์โหลด / เปิดไฟล์เต็ม'}
                                 </a>
                             </div>
                        </div>
                    </div>
                </div>
            );
        }

        function QuestionListEditor({ questions, onChange }) {
            const handleQuestionChange = (qIdx, field, value, optIdx = null) => {
                const newQuestions = [...questions];
                if (field === 'text') newQuestions[qIdx].text = value;
                if (field === 'explanation') newQuestions[qIdx].explanation = value;
                if (field === 'correctAnswer') newQuestions[qIdx].correctAnswer = parseInt(value);
                if (field === 'option' && optIdx !== null) newQuestions[qIdx].options[optIdx] = value;
                onChange(newQuestions);
            };

            const handleAddQuestion = () => {
                onChange([...questions, { text: '', options: ['','','',''], correctAnswer: 0, explanation: '' }]);
            };

            const handleRemoveQuestion = (qIdx) => {
                if (!window.confirm('ยืนยันลบข้อนี้?')) return;
                onChange(questions.filter((_, i) => i !== qIdx));
            };

            return (
                <div className="space-y-6">
                    {questions.map((q, idx) => (
                        <div key={idx} className="border rounded-lg p-4 bg-gray-50 relative group hover:shadow-md transition border-gray-200">
                            <div className="flex justify-between items-center mb-3">
                                <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">ข้อที่ {idx + 1}</span>
                                <button onClick={() => handleRemoveQuestion(idx)} className="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-100 transition"><Trash2 size={16}/></button>
                            </div>
                            
                            <div className="mb-3">
                                <input 
                                    className="w-full rounded border border-gray-300 p-2 text-sm font-medium focus:ring-1 focus:ring-blue-500 outline-none" 
                                    placeholder="โจทย์คำถาม"
                                    value={q.text} 
                                    onChange={e => handleQuestionChange(idx, 'text', e.target.value)} 
                                />
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                                {q.options.map((opt, optIdx) => (
                                    <div key={optIdx} className="flex items-center">
                                        <span className="w-6 text-center text-xs font-bold text-gray-500">{optIdx + 1}.</span>
                                        <input 
                                            className="flex-1 rounded border border-gray-300 p-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                                            placeholder={`ตัวเลือก ${optIdx + 1}`}
                                            value={opt}
                                            onChange={e => handleQuestionChange(idx, 'option', e.target.value, optIdx)}
                                        />
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center bg-white p-3 rounded border">
                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1">คำตอบที่ถูก (1-4)</label>
                                    <select 
                                        className="w-full rounded border p-1.5 text-sm outline-none focus:ring-1 focus:ring-green-500 bg-green-50 text-green-800 font-bold"
                                        value={q.correctAnswer + 1} 
                                        onChange={e => handleQuestionChange(idx, 'correctAnswer', parseInt(e.target.value) - 1)}
                                    >
                                        {[1,2,3,4].map(n => <option key={n} value={n}>ตัวเลือก {n}</option>)}
                                    </select>
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="block text-xs font-medium text-gray-500 mb-1">คำอธิบายเฉลย (Explanation)</label>
                                    <input 
                                        className="w-full rounded border p-1.5 text-sm outline-none focus:ring-1 focus:ring-blue-500"
                                        placeholder="อธิบายเหตุผล..."
                                        value={q.explanation || ''}
                                        onChange={e => handleQuestionChange(idx, 'explanation', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>
                    ))}
                    <button onClick={handleAddQuestion} className="mt-6 w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center font-medium">
                        <Plus size={20} className="mr-2"/> เพิ่มคำถามใหม่
                    </button>
                </div>
            );
        }

        // --- 2. Components ---

        function ExamApp() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('auth');

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Custom token auth failed", e);
                        }
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        try {
                            const userRef = getAppDoc('users', currentUser.uid);
                            const snapshot = await getDoc(userRef);
                            
                            if (snapshot.exists()) {
                                const data = snapshot.data();
                                setUserProfile(data);
                                if (data.approved) {
                                    setCurrentView(data.role === 'admin' ? 'admin-dashboard' : 'user-dashboard');
                                } else {
                                    setCurrentView('auth'); 
                                }
                            } else {
                                const isAdminEmail = currentUser.email && currentUser.email.toLowerCase().includes('admin');
                                const newProfile = {
                                    uid: currentUser.uid,
                                    email: currentUser.email || '',
                                    role: isAdminEmail ? 'admin' : 'user',
                                    approved: !!isAdminEmail
                                };
                                await setDoc(userRef, newProfile);
                                setUserProfile(newProfile);
                                setCurrentView(isAdminEmail ? 'admin-dashboard' : 'auth');
                            }
                        } catch (err) {
                            console.error("Profile Error:", err);
                        }
                    } else {
                        setUser(null);
                        setUserProfile(null);
                        setCurrentView('auth');
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-gray-50">
                        <div className="flex flex-col items-center animate-pulse">
                            <div className="h-12 w-12 rounded-full bg-blue-200 mb-4"></div>
                            <div className="h-4 w-32 bg-gray-200 rounded"></div>
                            <p className="mt-2 text-sm text-gray-400">กำลังโหลดระบบ...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {currentView === 'auth' && <AuthScreen user={user} userProfile={userProfile} />}
                    {currentView === 'user-dashboard' && <UserDashboard user={user} onLogout={() => signOut(auth)} />}
                    {currentView === 'admin-dashboard' && <AdminDashboard user={user} onLogout={() => signOut(auth)} onSwitchView={() => setCurrentView('user-dashboard')} />}
                </div>
            );
        }

        function AuthScreen({ user, userProfile }) {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [busy, setBusy] = useState(false);

            if (user && userProfile && !userProfile.approved) {
                return (
                    <div className="flex min-h-screen items-center justify-center bg-gray-100 p-4">
                        <div className="w-full max-w-md rounded-lg bg-white p-8 shadow-lg text-center">
                            <Clock className="mx-auto h-16 w-16 text-yellow-500 mb-4" />
                            <h2 className="text-2xl font-bold text-gray-800">รอการอนุมัติ</h2>
                            <p className="mt-2 text-gray-600">บัญชี <span className="font-semibold">{user.email}</span> ถูกสร้างเรียบร้อยแล้ว</p>
                            <p className="text-sm text-gray-500 mt-1">กรุณารอผู้ดูแลระบบ (Admin) อนุมัติสิทธิ์การเข้าใช้งาน</p>
                            
                            <div className="mt-6 space-y-3">
                                <div className="bg-yellow-50 border border-yellow-100 rounded p-3 text-xs text-yellow-700">
                                    สถานะ: <strong>Pending Approval</strong><br/>
                                    คุณจะไม่สามารถเข้าใช้งานได้จนกว่าจะได้รับอนุญาต
                                </div>
                                <button onClick={() => signOut(auth)} className="w-full rounded-lg border border-gray-300 py-2 text-gray-600 hover:bg-gray-50 transition">
                                    ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const handleSubmit = async (e) => {
                e.preventDefault();
                setBusy(true);
                setError('');
                try {
                    if (isRegister) {
                        const res = await createUserWithEmailAndPassword(auth, email, password);
                        const isAdmin = email.toLowerCase().includes('admin');
                        await setDoc(getAppDoc('users', res.user.uid), {
                            uid: res.user.uid,
                            email,
                            role: isAdmin ? 'admin' : 'user',
                            approved: !!isAdmin
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (msg.includes('auth/invalid-email')) msg = "รูปแบบอีเมลไม่ถูกต้อง";
                    if (msg.includes('auth/user-not-found') || msg.includes('auth/invalid-credential')) msg = "อีเมลหรือรหัสผ่านไม่ถูกต้อง";
                    if (msg.includes('auth/email-already-in-use')) msg = "อีเมลนี้ถูกใช้งานแล้ว";
                    if (msg.includes('auth/weak-password')) msg = "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร";
                    setError(msg);
                } finally {
                    setBusy(false);
                }
            };

            return (
                <div className="flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-900 p-4">
                    <div className="w-full max-w-sm rounded-xl bg-white p-8 shadow-2xl">
                        <div className="text-center mb-6">
                            <Book className="mx-auto h-12 w-12 text-blue-600" />
                            <h1 className="mt-2 text-2xl font-bold text-gray-900">ExamOnline</h1>
                            <p className="text-sm text-gray-500">ระบบสอบออนไลน์ครบวงจร</p>
                        </div>

                        {error && (
                            <div className="mb-4 flex items-center rounded bg-red-50 p-3 text-sm text-red-600 animate-fade-in-up">
                                <AlertCircle className="mr-2 h-4 w-4 flex-shrink-0" /> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-medium text-gray-700">อีเมล</label>
                                <input 
                                    type="email" required
                                    className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    placeholder="user@example.com"
                                />
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-700">รหัสผ่าน</label>
                                <input 
                                    type="password" required
                                    className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    placeholder="******"
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={busy}
                                className="w-full rounded-md bg-blue-600 py-2 text-white hover:bg-blue-700 disabled:opacity-50 transition"
                            >
                                {busy ? 'กำลังโหลด...' : (isRegister ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ')}
                            </button>
                        </form>
                        
                        <div className="mt-4 text-center text-sm">
                            <button onClick={() => setIsRegister(!isRegister)} className="text-blue-600 hover:underline">
                                {isRegister ? 'มีบัญชีแล้ว? เข้าสู่ระบบ' : 'ยังไม่มีบัญชี? สมัครสมาชิก'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function UserDashboard({ user, onLogout }) {
            const [tab, setTab] = useState('exam');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [previewItem, setPreviewItem] = useState(null);

            return (
                <div className="flex min-h-screen flex-col bg-gray-50">
                    <header className="sticky top-0 z-30 bg-white shadow-sm">
                        <div className="mx-auto flex h-16 max-w-7xl items-center justify-between px-4">
                            <div className="flex items-center space-x-2 font-bold text-gray-800 cursor-pointer" onClick={() => setTab('exam')}>
                                <Book className="h-6 w-6 text-blue-600" />
                                <span>ExamOnline</span>
                            </div>
                            
                            <nav className="hidden md:flex space-x-4">
                                <NavBtn active={tab === 'exam'} onClick={() => setTab('exam')} icon={<FileText size={18}/>} label="ทำข้อสอบ" />
                                <NavBtn active={tab === 'history'} onClick={() => setTab('history')} icon={<BarChart2 size={18}/>} label="ผลการสอบ" />
                                <NavBtn active={tab === 'analysis'} onClick={() => setTab('analysis')} icon={<PieChart size={18}/>} label="วิเคราะห์ผล" />
                                <NavBtn active={tab === 'doc'} onClick={() => setTab('doc')} icon={<PlayCircle size={18}/>} label="คลังความรู้" />
                            </nav>

                            <div className="hidden md:flex items-center space-x-3">
                                <span className="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">{user.email}</span>
                                <button onClick={onLogout} className="rounded-full bg-gray-100 p-2 hover:bg-red-50 hover:text-red-600 transition">
                                    <LogOut size={18} />
                                </button>
                            </div>

                            <button className="md:hidden" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                                {isMenuOpen ? <X /> : <Menu />}
                            </button>
                        </div>

                        {isMenuOpen && (
                            <div className="border-t bg-white p-4 md:hidden space-y-2 animate-fade-in-down">
                                <MobileBtn active={tab === 'exam'} onClick={() => {setTab('exam'); setIsMenuOpen(false)}} label="ทำข้อสอบ" />
                                <MobileBtn active={tab === 'history'} onClick={() => {setTab('history'); setIsMenuOpen(false)}} label="ผลการสอบ" />
                                <MobileBtn active={tab === 'analysis'} onClick={() => {setTab('analysis'); setIsMenuOpen(false)}} label="วิเคราะห์ผล" />
                                <MobileBtn active={tab === 'doc'} onClick={() => {setTab('doc'); setIsMenuOpen(false)}} label="คลังความรู้" />
                                <div className="border-t pt-2">
                                    <button onClick={onLogout} className="w-full text-left text-red-600 py-2">ออกจากระบบ</button>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="mx-auto w-full max-w-7xl flex-1 p-4 md:p-6">
                        {tab === 'exam' && <ExamListSection user={user} setTab={setTab} onPreview={setPreviewItem} />}
                        {tab === 'history' && <HistorySection user={user} />}
                        {tab === 'analysis' && <AnalysisSection user={user} />}
                        {tab === 'doc' && <ResourceSection onPreview={setPreviewItem} />}
                    </main>

                    <DocumentPreviewModal item={previewItem} onClose={() => setPreviewItem(null)} />
                </div>
            );
        }

        function AnalysisSection({ user }) {
            const [stats, setStats] = useState({ 
                good: [], 
                average: [], 
                improve: [], 
                totalExams: 0,
                avgScore: 0
            });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchStats = async () => {
                    const q = query(getAppCollection('scores'), where('userId', '==', user.uid));
                    const snapshot = await getDocs(q);
                    const scores = snapshot.docs.map(d => d.data());
                    
                    // Group by examTitle to average scores per subject
                    const examGroups = {};
                    scores.forEach(s => {
                        if (!examGroups[s.examTitle]) {
                            examGroups[s.examTitle] = { totalScore: 0, count: 0, title: s.examTitle, maxScore: s.totalQuestions };
                        }
                        examGroups[s.examTitle].totalScore += (s.score / s.totalQuestions) * 100;
                        examGroups[s.examTitle].count += 1;
                    });

                    const processed = Object.values(examGroups).map(g => ({
                        title: g.title,
                        percentage: Math.round(g.totalScore / g.count)
                    }));

                    setStats({
                        good: processed.filter(p => p.percentage >= 80),
                        average: processed.filter(p => p.percentage >= 50 && p.percentage < 80),
                        improve: processed.filter(p => p.percentage < 50),
                        totalExams: scores.length,
                        avgScore: scores.length > 0 ? Math.round(scores.reduce((acc, curr) => acc + (curr.score/curr.totalQuestions)*100, 0) / scores.length) : 0
                    });
                    setLoading(false);
                };
                fetchStats();
            }, [user]);

            if (loading) return <div className="text-center py-10"><Clock className="animate-spin inline mr-2"/> กำลังวิเคราะห์ข้อมูล...</div>;

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><PieChart className="mr-2"/> วิเคราะห์ผลการเรียน</h2>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="text-gray-500 text-sm mb-1">จำนวนครั้งที่สอบ</div>
                            <div className="text-2xl font-bold text-blue-600">{stats.totalExams}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="text-gray-500 text-sm mb-1">คะแนนเฉลี่ยรวม</div>
                            <div className="text-2xl font-bold text-purple-600">{stats.avgScore}%</div>
                        </div>
                    </div>

                    <div className="grid md:grid-cols-3 gap-6">
                        {/* Good */}
                        <div className="bg-green-50 rounded-xl p-5 border border-green-100">
                            <h3 className="font-bold text-green-800 mb-4 flex items-center"><Award className="mr-2 w-5 h-5"/> ยอดเยี่ยม (Score ≥ 80%)</h3>
                            {stats.good.length > 0 ? (
                                <ul className="space-y-2">
                                    {stats.good.map((item, i) => (
                                        <li key={i} className="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                                            <span className="font-medium text-gray-700 truncate mr-2">{item.title}</span>
                                            <span className="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">{item.percentage}%</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="text-center text-gray-400 py-4 text-sm">ยังไม่มีวิชาที่ได้คะแนนระดับนี้</div>
                            )}
                        </div>

                        {/* Average */}
                        <div className="bg-yellow-50 rounded-xl p-5 border border-yellow-100">
                            <h3 className="font-bold text-yellow-800 mb-4 flex items-center"><Activity className="mr-2 w-5 h-5"/> ปานกลาง (50-79%)</h3>
                            {stats.average.length > 0 ? (
                                <ul className="space-y-2">
                                    {stats.average.map((item, i) => (
                                        <li key={i} className="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                                            <span className="font-medium text-gray-700 truncate mr-2">{item.title}</span>
                                            <span className="bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-1 rounded">{item.percentage}%</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="text-center text-gray-400 py-4 text-sm">ยังไม่มีวิชาที่ได้คะแนนระดับนี้</div>
                            )}
                        </div>

                        {/* Improve */}
                        <div className="bg-red-50 rounded-xl p-5 border border-red-100">
                            <h3 className="font-bold text-red-800 mb-4 flex items-center"><TrendingUp className="mr-2 w-5 h-5"/> ต้องปรับปรุง (Score &lt; 50%)</h3>
                            {stats.improve.length > 0 ? (
                                <ul className="space-y-2">
                                    {stats.improve.map((item, i) => (
                                        <li key={i} className="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                                            <span className="font-medium text-gray-700 truncate mr-2">{item.title}</span>
                                            <span className="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded">{item.percentage}%</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="text-center text-gray-400 py-4 text-sm">เยี่ยมมาก! ไม่มีวิชาที่ต้องปรับปรุง</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ user, onLogout, onSwitchView }) {
            const [page, setPage] = useState('users');

            return (
                <div className="flex h-screen flex-col md:flex-row bg-gray-100">
                    <aside className="w-full bg-gray-900 text-white md:w-64 flex-shrink-0 flex flex-col">
                        <div className="flex h-16 items-center px-6 font-bold shadow-lg bg-gray-800">
                            <Shield className="mr-2 h-5 w-5 text-blue-400" /> Admin Panel
                        </div>
                        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
                            <AdminBtn active={page === 'users'} onClick={() => setPage('users')} icon={<Users size={20}/>} label="จัดการผู้ใช้" />
                            <AdminBtn active={page === 'exams'} onClick={() => setPage('exams')} icon={<FileText size={20}/>} label="คลังข้อสอบ" />
                            <AdminBtn active={page === 'content'} onClick={() => setPage('content')} icon={<Upload size={20}/>} label="เนื้อหาเสริม" />
                        </nav>
                        <div className="border-t border-gray-700 p-4 space-y-2">
                            <button onClick={onSwitchView} className="flex w-full items-center rounded px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition">
                                <Home size={16} className="mr-2"/> หน้า User
                            </button>
                            <button onClick={onLogout} className="flex w-full items-center rounded px-4 py-2 text-sm text-red-300 hover:bg-red-900/20 transition">
                                <LogOut size={16} className="mr-2"/> ออกจากระบบ
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-auto p-6">
                        <div className="mx-auto max-w-5xl rounded-lg bg-white p-6 shadow-sm min-h-[500px]">
                            {page === 'users' && <AdminUsersManager />}
                            {page === 'exams' && <AdminExamsManager />}
                            {page === 'content' && <AdminContentManager />}
                        </div>
                    </main>
                </div>
            );
        }

        function FeaturedResourceCard({ item, setTab, onPreview }) {
            const isVideo = item.type === 'video';
            const icon = isVideo ? <PlayCircle size={20} className="text-red-500" /> : <FileUp size={20} className="text-blue-500" />;
            
            const handleClick = () => {
                if (onPreview) {
                    onPreview(item);
                } else if (item.url) {
                    window.open(item.url, '_blank');
                }
            }

            return (
                <div className="overflow-hidden rounded-xl bg-white shadow-md transition hover:shadow-lg border border-gray-100 h-full flex flex-col group">
                    {isVideo && item.url ? (
                        <div className="aspect-video bg-black flex items-center justify-center relative cursor-pointer" onClick={handleClick}>
                            <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center z-10">
                                <PlayCircle className="text-white opacity-0 group-hover:opacity-100 transition transform scale-75 group-hover:scale-100" size={48} />
                            </div>
                            <iframe 
                                src={getYouTubeEmbedUrl(item.url)} 
                                className="h-full w-full pointer-events-none" // Disable pointer events to let the div handle click
                                title={item.title} 
                                frameBorder="0"
                            />
                        </div>
                    ) : (
                        <div className="flex h-32 items-center justify-center bg-blue-50 text-blue-600 group-hover:bg-blue-100 transition cursor-pointer" onClick={handleClick}>
                            <FileText size={48} />
                        </div>
                    )}
                    <div className="p-4 flex-1 flex flex-col">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center space-x-1">
                                {icon}
                                <span className="text-xs font-medium text-gray-500">{isVideo ? 'วิดีโอ' : 'เอกสาร'}</span>
                            </div>
                            <span className="rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                        </div>
                        <h3 className="font-bold text-gray-900 line-clamp-2 mb-3 flex-1 cursor-pointer hover:text-blue-600" onClick={handleClick}>{item.title}</h3>
                        <button 
                            onClick={handleClick}
                            className={`w-full flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-white transition mt-auto ${isVideo ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}
                        >
                            {isVideo ? <><PlayCircle size={16} className="mr-2"/> ดูวิดีโอ</> : <><Eye size={16} className="mr-2"/> ดูตัวอย่าง</>}
                        </button>
                    </div>
                </div>
            );
        }

        function ExamListSection({ user, setTab, onPreview }) {
            const [exams, setExams] = useState([]);
            const [docs, setDocs] = useState([]);
            const [videos, setVideos] = useState([]);
            const [loadingData, setLoadingData] = useState(true);
            const [runningExam, setRunningExam] = useState(null);

            const fetchData = async () => {
                setLoadingData(true);
                try {
                    const [examSnap, docSnap, videoSnap] = await Promise.all([
                        getDocs(query(getAppCollection('exams'))),
                        getDocs(query(getAppCollection('documents'))),
                        getDocs(query(getAppCollection('videos'))),
                    ]);

                    setExams(examSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setDocs(docSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'document' })));
                    setVideos(videoSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'video' })));
                } catch (error) {
                    console.error("Error fetching data for dashboard:", error);
                } finally {
                    setLoadingData(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            // คำนวณข้อมูลแนะนำล่วงหน้าเพื่อส่งให้ ExamRunner
            const recentDocs = docs.slice(0, 3).map(d => ({...d, id: d.id + '-doc'}));
            const recentVideos = videos.slice(0, 3).map(v => ({...v, id: v.id + '-vid'}));
            const allResources = [...recentDocs, ...recentVideos];

            if (runningExam) {
                return <ExamRunner exam={runningExam} user={user} onFinish={() => setRunningExam(null)} recentDocs={recentDocs} recentVideos={recentVideos} onPreview={onPreview} />;
            }
            
            return (
                <div className="space-y-10">
                    
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">เลือกวิชาสอบ</h2>
                        <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                            {exams.map(e => (
                                <div key={e.id} className="group relative overflow-hidden rounded-xl bg-white p-6 shadow-sm transition hover:shadow-md border border-gray-100">
                                    <div className="mb-4 flex items-center justify-between">
                                        <span className="rounded bg-blue-100 px-2 py-1 text-xs font-bold text-blue-700">{e.timeLimit} นาที</span>
                                        <FileText className="h-6 w-6 text-gray-300 group-hover:text-blue-500" />
                                    </div>
                                    <h3 className="mb-2 text-lg font-bold text-gray-900">{e.title}</h3>
                                    <p className="mb-4 text-sm text-gray-500 line-clamp-2">{e.description || "ไม่มีรายละเอียด"}</p>
                                    <button 
                                        onClick={() => setRunningExam(e)}
                                        className="w-full rounded-lg bg-blue-600 py-2 text-sm font-medium text-white hover:bg-blue-700 transition"
                                    >
                                        เริ่มทำข้อสอบ
                                    </button>
                                </div>
                            ))}
                            {exams.length === 0 && (
                                <div className="col-span-full flex flex-col items-center justify-center py-16 bg-white rounded-xl border border-dashed border-gray-300">
                                    <FileText className="w-16 h-16 text-gray-300 mb-4" />
                                    <p className="text-gray-500">ยังไม่มีข้อสอบในระบบ</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {loadingData && (
                         <div className="text-center py-10 text-gray-500 flex items-center justify-center">
                            <Clock className="w-4 h-4 mr-2 animate-spin"/> กำลังโหลดข้อมูลแนะนำ...
                         </div>
                    )}

                    {!loadingData && (recentDocs.length > 0 || recentVideos.length > 0) && (
                        <div className="border-t pt-6 border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center mb-6">
                                <PlayCircle className="w-6 h-6 mr-2 text-blue-600"/> คลังความรู้แนะนำ
                            </h2>
                            
                            {/* ส่วนแสดงเอกสาร */}
                            {recentDocs.length > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารล่าสุด
                                    </h3>
                                    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                        {recentDocs.map((item) => (
                                            <FeaturedResourceCard key={item.id} item={item} setTab={setTab} onPreview={onPreview} />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* ส่วนแสดงวิดีโอ */}
                            {recentVideos.length > 0 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอล่าสุด
                                    </h3>
                                    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                        {recentVideos.map((item) => (
                                            <FeaturedResourceCard key={item.id} item={item} setTab={setTab} onPreview={onPreview} />
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {allResources.length > 0 && (
                                 <div className="text-right mt-6">
                                     <button 
                                        onClick={() => setTab('doc')}
                                        className="rounded-full bg-blue-50 px-4 py-2 text-sm text-blue-600 font-medium hover:bg-blue-100 transition flex items-center justify-end ml-auto w-fit"
                                    >
                                        ดูเนื้อหาทั้งหมด <FileText className="w-4 h-4 ml-1" />
                                    </button>
                                 </div>
                            )}
                        </div>
                    )}

                </div>
            );
        }

        function ExamRunner({ exam, user, onFinish, recentDocs, recentVideos, onPreview }) {
            const [idx, setIdx] = useState(0);
            const [ans, setAns] = useState({});
            const [timer, setTimer] = useState(exam.timeLimit * 60);
            const [done, setDone] = useState(false);
            const [score, setScore] = useState(0);
            const [checkedStatus, setCheckedStatus] = useState({});
            
            // Resources Logic
            // Updated hasResources to check for infographic and mindmap
            const hasResources = exam.fullFileUrl || exam.videoUrl || exam.summaryUrl || exam.slideUrl || exam.infographicUrl || exam.mindmapUrl;
            const [showResourcePanel, setShowResourcePanel] = useState(false);
            const [activeResourceTab, setActiveResourceTab] = useState('exam'); // exam, video, summary, slide, infographic, mindmap

            // Auto-open logic
            useEffect(() => {
                if (showResourcePanel) {
                    if (activeResourceTab === 'exam' && !exam.fullFileUrl) {
                        if (exam.videoUrl) setActiveResourceTab('video');
                        else if (exam.summaryUrl) setActiveResourceTab('summary');
                        else if (exam.slideUrl) setActiveResourceTab('slide');
                        else if (exam.infographicUrl) setActiveResourceTab('infographic');
                        else if (exam.mindmapUrl) setActiveResourceTab('mindmap');
                    }
                }
            }, [showResourcePanel]);

            useEffect(() => {
                if (done) return;
                const interval = setInterval(() => {
                    setTimer(t => {
                        if (t <= 1) {
                            handleSubmit();
                            return 0;
                        }
                        return t - 1;
                    });
                }, 1000);
                return () => clearInterval(interval);
            }, [done]);

            const handleSubmit = async () => {
                let s = 0;
                exam.questions.forEach((q, i) => {
                    if (ans[i] === q.correctAnswer) s++;
                });
                setScore(s);
                setDone(true);
                setShowResourcePanel(false); 
                
                await addDoc(getAppCollection('scores'), {
                    userId: user.uid,
                    examId: exam.id,
                    examTitle: exam.title,
                    score: s,
                    totalQuestions: exam.questions.length,
                    timestamp: serverTimestamp()
                });
            };
            
            const handleAnswer = (optionIndex) => {
                if (checkedStatus[idx]) return; 
                setAns(prev => ({ ...prev, [idx]: optionIndex }));
                setCheckedStatus(prev => ({ ...prev, [idx]: true }));
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${String(s).padStart(2, '0')}`;
            };

            const RecommendedResourcesSection = () => (
                <div className="mt-12 border-t pt-8">
                     <h3 className="text-xl font-bold text-gray-800 flex items-center mb-6">
                        <PlayCircle className="w-6 h-6 mr-2 text-blue-600"/> คลังความรู้แนะนำ
                    </h3>
                    {recentDocs && recentDocs.length > 0 && (
                        <div className="mb-8">
                            <h4 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารล่าสุด
                            </h4>
                            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                {recentDocs.map((item) => (
                                    <FeaturedResourceCard key={item.id} item={item} onPreview={onPreview} />
                                ))}
                            </div>
                        </div>
                    )}
                    {recentVideos && recentVideos.length > 0 && (
                        <div>
                            <h4 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอล่าสุด
                            </h4>
                            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                {recentVideos.map((item) => (
                                    <FeaturedResourceCard key={item.id} item={item} onPreview={onPreview} />
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );

            if (done) {
                const percentage = Math.round((score / exam.questions.length) * 100);
                return (
                    <div className="mx-auto max-w-3xl">
                        <div className="rounded-xl bg-white p-8 shadow text-center animate-fade-in-up mb-8">
                            {percentage >= 50 ? 
                                <Award className="mx-auto h-20 w-20 text-yellow-400 mb-4 animate-bounce" /> :
                                <div className="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4"><X className="text-red-500 w-10 h-10"/></div>
                            }
                            <h2 className="text-3xl font-bold mb-2 text-gray-800">ส่งคำตอบเรียบร้อย</h2>
                            <p className="text-gray-500 mb-8">{exam.title}</p>
                            <div className="grid grid-cols-3 gap-4 mb-8">
                                <div className="p-3 bg-blue-50 rounded-lg">
                                    <div className="text-2xl font-bold text-blue-600">{score}</div>
                                    <div className="text-xs text-gray-500">คะแนน</div>
                                </div>
                                <div className="p-3 bg-gray-50 rounded-lg">
                                    <div className="text-2xl font-bold text-gray-700">{exam.questions.length}</div>
                                    <div className="text-xs text-gray-500">เต็ม</div>
                                </div>
                                <div className={`p-3 rounded-lg ${percentage >= 50 ? 'bg-green-50' : 'bg-red-50'}`}>
                                    <div className={`text-2xl font-bold ${percentage >= 50 ? 'text-green-600' : 'text-red-600'}`}>{percentage}%</div>
                                    <div className="text-xs text-gray-500">ผลลัพธ์</div>
                                </div>
                            </div>
                            
                            <div className="mt-10 text-left border-t pt-6">
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><CheckCircle className="w-5 h-5 mr-2 text-green-600"/> เฉลยละเอียด</h3>
                                <div className="space-y-6">
                                    {exam.questions.map((q, i) => {
                                        const isCorrect = ans[i] === q.correctAnswer;
                                        return (
                                            <div key={i} className={`p-4 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                <div className="flex items-start mb-2">
                                                    <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold mr-2 text-white ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`}>
                                                        {i + 1}
                                                    </span>
                                                    <span className="font-medium text-gray-900">{q.text}</span>
                                                </div>
                                                <div className="ml-8 text-sm space-y-1">
                                                    <div className="flex items-center">
                                                        <span className="w-24 text-gray-500">คำตอบของคุณ:</span>
                                                        <span className={`font-bold ${isCorrect ? 'text-green-700' : 'text-red-600'}`}>
                                                            {q.options[ans[i]] !== undefined ? q.options[ans[i]] : '(ไม่ได้ตอบ)'}
                                                        </span>
                                                    </div>
                                                    {!isCorrect && (
                                                        <div className="flex items-center">
                                                            <span className="w-24 text-gray-500">เฉลยถูกต้อง:</span>
                                                            <span className="font-bold text-green-700">{q.options[q.correctAnswer]}</span>
                                                        </div>
                                                    )}
                                                    {q.explanation && (
                                                        <div className="mt-2 pt-2 border-t border-gray-200 text-sm text-gray-600">
                                                            <span className="font-semibold">คำอธิบาย:</span> {q.explanation}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="mt-8">
                                <button onClick={onFinish} className="rounded-lg bg-gray-800 px-6 py-2 text-white hover:bg-gray-900 transition">กลับหน้าหลัก</button>
                            </div>
                        </div>
                        <RecommendedResourcesSection />
                    </div>
                );
            }

            const q = exam.questions[idx];
            const isChecked = checkedStatus[idx];
            const isCorrect = isChecked && ans[idx] === q.correctAnswer;
            
            // Layout Logic
            const isSplitView = hasResources && showResourcePanel;

            // Resource Content Resolver
            let resourceContent = null;
            let currentUrl = null;
            
            if (activeResourceTab === 'exam') currentUrl = exam.fullFileUrl;
            if (activeResourceTab === 'video') currentUrl = exam.videoUrl;
            if (activeResourceTab === 'summary') currentUrl = exam.summaryUrl;
            if (activeResourceTab === 'slide') currentUrl = exam.slideUrl;
            if (activeResourceTab === 'infographic') currentUrl = exam.infographicUrl;
            if (activeResourceTab === 'mindmap') currentUrl = exam.mindmapUrl;

            // Embed Logic
            if (activeResourceTab === 'video' && currentUrl) {
                resourceContent = (
                    <iframe src={getYouTubeEmbedUrl(currentUrl)} className="h-full w-full bg-black" title="Video Resource" frameBorder="0" allowFullScreen />
                );
            } else if (currentUrl) {
                resourceContent = (
                     <iframe src={getDocumentEmbedUrl(currentUrl)} className="h-full w-full bg-white" title="Document Resource" frameBorder="0" allowFullScreen />
                );
            } else {
                resourceContent = (
                    <div className="h-full w-full flex flex-col items-center justify-center text-gray-400 bg-gray-50">
                        <FileText size={48} className="mb-2 opacity-50"/>
                        <p>ไม่มีข้อมูลในส่วนนี้</p>
                    </div>
                );
            }

            return (
                <div className="mx-auto max-w-7xl pb-12 px-2 sm:px-4">
                    {/* Header Bar */}
                    <div className="sticky top-16 z-20 mb-6 flex justify-between items-center bg-white p-4 rounded-xl shadow-md border border-gray-100">
                        <div className="flex items-center gap-4">
                            <span className="font-bold text-gray-800 text-lg hidden sm:inline">{exam.title}</span>
                            <span className="font-bold text-gray-800 text-sm sm:hidden">ข้อที่ {idx + 1}/{exam.questions.length}</span>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            {hasResources && (
                                <button 
                                    onClick={() => setShowResourcePanel(!showResourcePanel)}
                                    className={`hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition ${showResourcePanel ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                    {showResourcePanel ? <><Maximize2 size={16}/> ซ่อนเนื้อหา</> : <><Columns size={16}/> แสดงเนื้อหาประกอบ</>}
                                </button>
                            )}
                            <span className={`font-mono font-bold px-3 py-1.5 rounded-lg flex items-center ${timer < 60 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-blue-50 text-blue-600'}`}>
                                <Clock className="inline w-4 h-4 mr-1.5"/> {formatTime(timer)}
                            </span>
                        </div>
                    </div>
                    
                    {/* Main Content Grid */}
                    <div className={`grid gap-6 ${isSplitView ? 'lg:grid-cols-12' : ''}`}>
                        
                        {/* Left Column: Question Card */}
                        <div className={`${isSplitView ? 'lg:col-span-5 xl:col-span-5' : 'mx-auto max-w-3xl'}`}>
                             <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 relative">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="font-bold text-gray-500 text-sm">ข้อที่ {idx + 1} / {exam.questions.length}</span>
                                    {/* Mobile Toggle Button */}
                                    {hasResources && (
                                        <button 
                                            onClick={() => setShowResourcePanel(!showResourcePanel)}
                                            className="sm:hidden text-blue-600 text-xs font-bold flex items-center bg-blue-50 px-2 py-1 rounded"
                                        >
                                            {showResourcePanel ? 'ซ่อน' : 'ดูเนื้อหา'}
                                        </button>
                                    )}
                                </div>
                                <div className="h-1.5 bg-gray-100 rounded-full mb-6">
                                     <div className="h-full bg-blue-500 rounded-full transition-all duration-300" style={{ width: `${((idx + 1) / exam.questions.length) * 100}%` }}></div>
                                </div>
                                <p className="text-lg font-medium mb-6 text-gray-900 leading-relaxed">{q.text}</p>
                                <div className="space-y-3">
                                    {q.options.map((opt, i) => {
                                        let btnClass = "border-gray-200 hover:bg-gray-50";
                                        let circleClass = "text-gray-500 bg-white group-hover:bg-blue-50";
                                        let textClass = "";

                                        if (isChecked) {
                                            if (i === q.correctAnswer) {
                                                btnClass = "border-green-500 bg-green-50 ring-1 ring-green-500";
                                                circleClass = "bg-green-600 text-white border-green-600";
                                                textClass = "text-green-800 font-medium";
                                            } else if (ans[idx] === i) {
                                                btnClass = "border-red-500 bg-red-50 ring-1 ring-red-500";
                                                circleClass = "bg-red-600 text-white border-red-600";
                                                textClass = "text-red-800 font-medium";
                                            } else {
                                                btnClass = "border-gray-100 opacity-50";
                                            }
                                        } else if (ans[idx] === i) {
                                            btnClass = "border-blue-500 bg-blue-50 ring-1 ring-blue-500 text-blue-800";
                                            circleClass = "bg-blue-600 text-white border-blue-600";
                                        }

                                        return (
                                            <button
                                                key={i}
                                                onClick={() => handleAnswer(i)}
                                                disabled={isChecked}
                                                className={`flex w-full items-center rounded-lg border p-3 sm:p-4 text-left transition group ${btnClass}`}
                                            >
                                                <div className={`mr-3 flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full border font-bold text-sm transition flex-shrink-0 ${circleClass}`}>
                                                    {['A','B','C','D'][i]}
                                                </div>
                                                <span className={`text-sm sm:text-base ${textClass}`}>{opt}</span>
                                                {isChecked && i === q.correctAnswer && <CheckCircle className="ml-auto w-5 h-5 text-green-600 flex-shrink-0"/>}
                                                {isChecked && ans[idx] === i && i !== q.correctAnswer && <X className="ml-auto w-5 h-5 text-red-600 flex-shrink-0"/>}
                                            </button>
                                        );
                                    })}
                                </div>
                                {isChecked && (
                                    <div className={`mt-6 p-4 rounded-lg border animate-fade-in-up ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex items-center mb-2">
                                            {isCorrect ? <CheckCircle className="w-5 h-5 text-green-600 mr-2"/> : <X className="w-5 h-5 text-red-600 mr-2"/>}
                                            <span className={`font-bold ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                                {isCorrect ? 'ถูกต้อง!' : 'ผิดครับ! คำตอบที่ถูกคือ ' + ['A','B','C','D'][q.correctAnswer]}
                                            </span>
                                        </div>
                                        {q.explanation && (
                                            <div className="text-sm text-gray-600 ml-7">
                                                <span className="font-semibold">คำอธิบาย:</span> {q.explanation}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            <div className="flex justify-between mb-10">
                                <button disabled={idx === 0} onClick={() => setIdx(idx - 1)} className="rounded-lg bg-gray-200 px-6 py-2.5 disabled:opacity-50 font-medium text-gray-600 hover:bg-gray-300 transition">ย้อนกลับ</button>
                                {idx === exam.questions.length - 1 ? (
                                    <button onClick={handleSubmit} className="rounded-lg bg-green-600 px-8 py-2.5 text-white hover:bg-green-700 font-bold shadow-lg transition transform hover:-translate-y-0.5">ส่งคำตอบ</button>
                                ) : (
                                    <button onClick={() => setIdx(idx + 1)} className="rounded-lg bg-blue-600 px-8 py-2.5 text-white hover:bg-blue-700 font-bold shadow-lg transition transform hover:-translate-y-0.5">ถัดไป</button>
                                )}
                            </div>
                        </div>

                        {/* Right Column: Resource Viewer Panel */}
                        {isSplitView && (
                            <div className="lg:col-span-7 xl:col-span-7">
                                <div className="lg:sticky lg:top-28 h-[500px] lg:h-[calc(100vh-10rem)] bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col animate-fade-in-up">
                                     {/* Resource Tabs */}
                                     <div className="bg-gray-50 border-b flex overflow-x-auto">
                                         {exam.fullFileUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('exam')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'exam' ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <FileText size={16} className="mr-2"/> ข้อสอบ
                                            </button>
                                         )}
                                         {exam.videoUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('video')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'video' ? 'border-red-600 text-red-600 bg-red-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <PlayCircle size={16} className="mr-2"/> วิดีโอ
                                            </button>
                                         )}
                                         {exam.summaryUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('summary')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'summary' ? 'border-green-600 text-green-600 bg-green-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <FileBox size={16} className="mr-2"/> สรุปย่อ
                                            </button>
                                         )}
                                         {exam.slideUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('slide')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'slide' ? 'border-orange-600 text-orange-600 bg-orange-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <Presentation size={16} className="mr-2"/> สไลด์
                                            </button>
                                         )}
                                         {exam.infographicUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('infographic')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'infographic' ? 'border-pink-600 text-pink-600 bg-pink-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <Image size={16} className="mr-2"/> Infographic
                                            </button>
                                         )}
                                         {exam.mindmapUrl && (
                                            <button 
                                                onClick={() => setActiveResourceTab('mindmap')}
                                                className={`flex items-center px-4 py-3 text-sm font-medium border-b-2 whitespace-nowrap ${activeResourceTab === 'mindmap' ? 'border-teal-600 text-teal-600 bg-teal-50' : 'border-transparent text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <Network size={16} className="mr-2"/> Mind Map
                                            </button>
                                         )}
                                         <div className="ml-auto px-4 py-3 flex items-center">
                                            {currentUrl && <a href={currentUrl} target="_blank" className="text-gray-400 hover:text-blue-600"><ExternalLink size={16}/></a>}
                                         </div>
                                     </div>

                                     {/* Content */}
                                     <div className="relative flex-1 bg-gray-100">
                                         <div className="absolute inset-0 flex items-center justify-center z-0">
                                            <div className="flex flex-col items-center text-gray-400">
                                                <Clock className="w-8 h-8 mb-2 animate-spin"/>
                                                <span>กำลังโหลดไฟล์...</span>
                                            </div>
                                         </div>
                                         <div className="relative z-10 h-full w-full bg-white">
                                            {resourceContent}
                                         </div>
                                     </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-8">
                        <div className="text-sm text-gray-500 mb-2 flex items-center">
                            <Book className="w-4 h-4 mr-1"/> แนะนำ: สามารถศึกษาข้อมูลเพิ่มเติมได้
                        </div>
                        <RecommendedResourcesSection />
                    </div>
                </div>
            );
        }

        function HistorySection({ user }) {
            const [logs, setLogs] = useState([]);
            const [deleteItem, setDeleteItem] = useState(null);

            const fetchHistory = () => {
                const q = query(getAppCollection('scores'), where('userId', '==', user.uid));
                
                getDocs(q).then(s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a, b) => {
                        const timeA = a.timestamp ? a.timestamp.seconds : Date.now() / 1000;
                        const timeB = b.timestamp ? b.timestamp.seconds : Date.now() / 1000;
                        return timeB - timeA;
                    });
                    setLogs(data);
                });
            };

            useEffect(() => {
                fetchHistory();
            }, [user]);

            const handleDelete = async () => {
                if (deleteItem) {
                    try {
                        await deleteDoc(getAppDoc('scores', deleteItem.id));
                        setDeleteItem(null);
                        fetchHistory(); // Refresh list
                    } catch (error) {
                        console.error("Error deleting log:", error);
                        alert("ไม่สามารถลบข้อมูลได้");
                    }
                }
            };

            return (
                <div className="rounded-lg bg-white shadow-sm overflow-hidden">
                    <div className="border-b px-6 py-4 bg-gray-50">
                        <h2 className="text-lg font-bold text-gray-800">ประวัติการสอบ</h2>
                    </div>
                    <div className="divide-y">
                        {logs.map((l, i) => (
                            <div key={i} className="flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition group">
                                <div className="flex-1">
                                    <p className="font-bold text-gray-900">{l.examTitle}</p>
                                    <p className="text-xs text-gray-500 flex items-center mt-1">
                                        <Clock className="w-3 h-3 mr-1"/> 
                                        {l.timestamp ? l.timestamp.toDate().toLocaleString('th-TH') : 'กำลังบันทึก...'}
                                    </p>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right">
                                        <span className="block text-lg font-bold text-blue-600">{l.score} / {l.totalQuestions}</span>
                                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${l.score/l.totalQuestions >= 0.5 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {l.score/l.totalQuestions >= 0.5 ? 'ผ่านเกณฑ์' : 'ไม่ผ่าน'}
                                        </span>
                                    </div>
                                    <button 
                                        onClick={() => setDeleteItem(l)}
                                        className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition opacity-0 group-hover:opacity-100"
                                        title="ลบประวัติ"
                                    >
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        ))}
                        {logs.length === 0 && <div className="p-8 text-center text-gray-500">ไม่มีประวัติการสอบ</div>}
                    </div>

                    <ConfirmationModal 
                        isOpen={!!deleteItem} 
                        onClose={() => setDeleteItem(null)} 
                        onConfirm={handleDelete} 
                        title="ยืนยันการลบ" 
                        message={`คุณต้องการลบรายการ "${deleteItem?.title || deleteItem?.examTitle}" ใช่หรือไม่?`}
                        confirmText="ลบรายการ"
                        confirmColor="bg-red-600 hover:bg-red-700"
                    />
                </div>
            );
        }

        function ResourceSection({ onPreview }) {
            const [docs, setDocs] = useState([]);
            const [videos, setVideos] = useState([]);

            useEffect(() => {
                Promise.all([getDocs(getAppCollection('documents')), getDocs(getAppCollection('videos'))])
                    .then(([d, v]) => {
                        setDocs(d.docs.map(x => ({...x.data(), id: x.id, type: 'document'})));
                        setVideos(v.docs.map(x => ({...x.data(), id: x.id, type: 'video'})));
                    });
            }, []);

            return (
                <div>
                    <h2 className="mb-6 text-2xl font-bold text-gray-800">คลังความรู้</h2>
                    
                    {/* ส่วนเอกสารทั้งหมด */}
                    <div className="mb-10">
                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                             <FileText className="w-5 h-5 mr-2 text-blue-500"/> เอกสารทั้งหมด
                        </h3>
                        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            {docs.map((item, i) => (
                                <div key={i} className="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-100 hover:shadow-md transition group flex flex-col">
                                    <div className="flex h-32 items-center justify-center bg-blue-50 text-blue-600 group-hover:bg-blue-100 transition cursor-pointer" onClick={() => onPreview(item)}>
                                        <FileText size={48} />
                                    </div>
                                    <div className="p-4 flex-1 flex flex-col">
                                        <div className="mb-2">
                                            <span className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                                        </div>
                                        <h3 className="font-bold text-gray-900 line-clamp-1 mb-3 cursor-pointer hover:text-blue-600" onClick={() => onPreview(item)}>{item.title}</h3>
                                        <button 
                                            onClick={() => onPreview(item)}
                                            className="w-full flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 transition mt-auto"
                                        >
                                            <Eye size={16} className="mr-2"/> ดูตัวอย่าง
                                        </button>
                                    </div>
                                </div>
                            ))}
                            {docs.length === 0 && <div className="col-span-full text-center py-6 text-gray-400">ไม่มีเอกสาร</div>}
                        </div>
                    </div>

                    {/* ส่วนวิดีโอทั้งหมด */}
                    <div>
                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                            <Video className="w-5 h-5 mr-2 text-red-500"/> วิดีโอล่าสุด
                        </h3>
                        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            {videos.map((item, i) => (
                                <div key={i} className="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-100 hover:shadow-md transition group flex flex-col">
                                    <div className="aspect-video bg-black cursor-pointer" onClick={() => onPreview(item)}>
                                        <iframe 
                                            src={getYouTubeEmbedUrl(item.url)} 
                                            className="h-full w-full pointer-events-none" 
                                            title={item.title} 
                                            frameBorder="0"
                                        />
                                    </div>
                                    <div className="p-4 flex-1 flex flex-col">
                                        <div className="mb-2">
                                            <span className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600 font-medium">{item.category || 'ทั่วไป'}</span>
                                        </div>
                                        <h3 className="font-bold text-gray-900 line-clamp-1 mb-3 cursor-pointer hover:text-blue-600" onClick={() => onPreview(item)}>{item.title}</h3>
                                        <button 
                                            onClick={() => onPreview(item)}
                                            className="w-full flex items-center justify-center rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 transition mt-auto"
                                        >
                                            <PlayCircle size={16} className="mr-2"/> ดูวิดีโอ
                                        </button>
                                    </div>
                                </div>
                            ))}
                            {videos.length === 0 && <div className="col-span-full text-center py-6 text-gray-400">ไม่มีวิดีโอ</div>}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Admin Managers ---

        function AdminUsersManager() {
            const [users, setUsers] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', data: null });
            
            const reload = () => getDocs(getAppCollection('users')).then(s => setUsers(s.docs.map(d => d.data())));
            useEffect(() => { reload(); }, []);

            const handleAction = (type, user) => {
                setModalConfig({ isOpen: true, type, data: user });
            };
            
            const confirmAction = async () => {
                const { type, data } = modalConfig;
                if (type === 'approve') {
                    await updateDoc(getAppDoc('users', data.uid), { approved: !data.approved });
                } else if (type === 'role') {
                    const newRole = data.role === 'admin' ? 'user' : 'admin';
                    await updateDoc(getAppDoc('users', data.uid), { role: newRole });
                }
                reload();
            };

            return (
                <div>
                    <h3 className="mb-4 text-xl font-bold">รายชื่อผู้ใช้งาน ({users.length})</h3>
                    <div className="overflow-hidden rounded border shadow-sm">
                        <table className="min-w-full divide-y bg-white">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Email</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Role</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>
                                    <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {users.map(u => (
                                    <tr key={u.uid} className="hover:bg-gray-50">
                                        <td className="px-4 py-3 text-sm">{u.email}</td>
                                        <td className="px-4 py-3 text-sm">
                                            <span className={`rounded px-2 py-0.5 text-xs font-bold uppercase ${u.role==='admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`}>{u.role}</span>
                                        </td>
                                        <td className="px-4 py-3 text-sm">{u.approved ? <span className="text-green-600 font-medium flex items-center"><CheckCircle className="w-3 h-3 mr-1"/> Active</span> : <span className="text-yellow-600 font-medium flex items-center"><Clock className="w-3 h-3 mr-1"/> Pending</span>}</td>
                                        <td className="px-4 py-3 text-sm space-x-2">
                                            <button onClick={() => handleAction('approve', u)} className={`text-xs font-medium px-2 py-1 rounded border ${u.approved ? 'text-red-500 border-red-200 hover:bg-red-50' : 'text-green-600 border-green-200 hover:bg-green-50'}`}>
                                                {u.approved ? 'ระงับ' : 'อนุมัติ'}
                                            </button>
                                            <button onClick={() => handleAction('role', u)} className="text-xs font-medium px-2 py-1 rounded border border-gray-200 text-gray-600 hover:bg-gray-100" title="เปลี่ยนสิทธิ์">
                                                {u.role === 'admin' ? <UserX className="w-3 h-3"/> : <UserCheck className="w-3 h-3"/>}
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <ConfirmationModal 
                        isOpen={modalConfig.isOpen}
                        onClose={() => setModalConfig({...modalConfig, isOpen: false})}
                        onConfirm={confirmAction}
                        title={modalConfig.type === 'approve' ? (modalConfig.data?.approved ? "ยืนยันการระงับผู้ใช้" : "ยืนยันการอนุมัติผู้ใช้") : "ยืนยันการเปลี่ยนสิทธิ์"}
                        message={modalConfig.type === 'approve' 
                            ? `คุณต้องการ${modalConfig.data?.approved ? 'ระงับ' : 'อนุมัติ'}ผู้ใช้ ${modalConfig.data?.email} ใช่หรือไม่?`
                            : `คุณต้องการเปลี่ยนสิทธิ์ผู้ใช้ ${modalConfig.data?.email} เป็น ${modalConfig.data?.role === 'admin' ? 'User' : 'Admin'} ใช่หรือไม่?`
                        }
                        confirmColor={modalConfig.type === 'approve' && modalConfig.data?.approved ? "bg-red-600 hover:bg-red-700" : "bg-green-600 hover:bg-green-700"}
                    />
                </div>
            );
        }

        function AdminExamsManager() {
            const [exams, setExams] = useState([]);
            const [isOpen, setIsOpen] = useState(false);
            // Unified form state for Create - added infographicUrl and mindmapUrl
            const [createForm, setCreateForm] = useState({ 
                title: '', 
                timeLimit: 30, 
                questions: [], 
                fullFileUrl: '',
                videoUrl: '',
                summaryUrl: '',
                slideUrl: '',
                infographicUrl: '',
                mindmapUrl: ''
            });
            
            const [error, setError] = useState('');
            const [deleteId, setDeleteId] = useState(null);
            const [editingExam, setEditingExam] = useState(null);
            const fileInputRef = useRef(null);

            const reload = () => getDocs(getAppCollection('exams')).then(s => setExams(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            useEffect(() => { reload(); }, []);

            const handleCreate = async () => {
                setError('');
                if (!createForm.title) {
                    setError('กรุณาระบุชื่อวิชา');
                    return;
                }
                if (createForm.questions.length === 0) {
                    setError('กรุณาเพิ่มคำถามอย่างน้อย 1 ข้อ');
                    return;
                }
                
                if (createForm.questions.some(q => !q.text || q.options.some(o => !o))) {
                     if(!window.confirm('มีบางข้อที่ข้อมูลไม่ครบถ้วน (โจทย์หรือตัวเลือกว่าง) ต้องการบันทึกหรือไม่?')) return;
                }
                
                await addDoc(getAppCollection('exams'), { 
                    title: createForm.title, 
                    timeLimit: createForm.timeLimit, 
                    questions: createForm.questions,
                    fullFileUrl: createForm.fullFileUrl || '',
                    videoUrl: createForm.videoUrl || '',
                    summaryUrl: createForm.summaryUrl || '',
                    slideUrl: createForm.slideUrl || '',
                    infographicUrl: createForm.infographicUrl || '',
                    mindmapUrl: createForm.mindmapUrl || '',
                    description: 'สร้างโดย Admin' 
                });
                
                setIsOpen(false); 
                setCreateForm({ title: '', timeLimit: 30, questions: [], fullFileUrl: '', videoUrl: '', summaryUrl: '', slideUrl: '', infographicUrl: '', mindmapUrl: '' });
                reload();
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => { 
                        try {
                            const parsedRows = parseCSV(evt.target.result);
                            const importedQuestions = convertCSVToQuestions(parsedRows);
                            if (importedQuestions.length > 0) {
                                setCreateForm(prev => ({
                                    ...prev,
                                    questions: [...prev.questions, ...importedQuestions]
                                }));
                                setError('');
                            } else {
                                setError('ไม่พบข้อมูลคำถามในไฟล์ CSV');
                            }
                        } catch (err) {
                            console.error(err);
                            setError('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV');
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = null;
                }
            };

            const handleDelete = async () => {
                if (deleteId) {
                   await deleteDoc(getAppDoc('exams', deleteId)); 
                   reload();
                }
            };

            const handleEdit = (exam) => {
                setEditingExam(JSON.parse(JSON.stringify(exam)));
            };

            const handleUpdateExam = async () => {
                if (!editingExam) return;
                if (!editingExam.title) { alert('กรุณาระบุชื่อวิชา'); return; }
                
                try {
                    await updateDoc(getAppDoc('exams', editingExam.id), {
                        title: editingExam.title,
                        timeLimit: editingExam.timeLimit,
                        questions: editingExam.questions,
                        fullFileUrl: editingExam.fullFileUrl || '',
                        videoUrl: editingExam.videoUrl || '',
                        summaryUrl: editingExam.summaryUrl || '',
                        slideUrl: editingExam.slideUrl || '',
                        infographicUrl: editingExam.infographicUrl || '',
                        mindmapUrl: editingExam.mindmapUrl || ''
                    });
                    setEditingExam(null);
                    reload();
                } catch (err) {
                    console.error("Update failed", err);
                    alert("เกิดข้อผิดพลาดในการบันทึก");
                }
            };

            return (
                <div>
                    <div className="mb-4 flex items-center justify-between">
                        <h3 className="text-xl font-bold">จัดการข้อสอบ</h3>
                        <button onClick={() => setIsOpen(true)} className="rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700 transition flex items-center"><Plus className="w-4 h-4 mr-1"/> เพิ่มข้อสอบ</button>
                    </div>

                    {/* Create Exam Form */}
                    {isOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm overflow-y-auto">
                            <div className="w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl sticky top-0 z-10">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center"><Plus className="w-5 h-5 mr-2 text-blue-600"/> เพิ่มข้อสอบใหม่</h3>
                                    <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                                </div>

                                <div className="p-6 overflow-y-auto flex-1">
                                    {error && <div className="mb-4 text-sm text-red-600 bg-red-100 border border-red-200 rounded p-2 flex items-center"><AlertCircle className="w-4 h-4 mr-2"/>{error}</div>}
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อวิชา</label>
                                            <input className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="เช่น คณิตศาสตร์ ม.1" value={createForm.title} onChange={e => setCreateForm({...createForm, title: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">เวลาสอบ (นาที)</label>
                                            <input type="number" className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={createForm.timeLimit} onChange={e => setCreateForm({...createForm, timeLimit: Number(e.target.value)})} />
                                        </div>
                                    </div>

                                    {/* URLs Inputs */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ไฟล์ข้อสอบฉบับเต็ม (PDF)</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={createForm.fullFileUrl} onChange={e => setCreateForm({...createForm, fullFileUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์วิดีโอเฉลย/สอน</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="YouTube URL..." value={createForm.videoUrl} onChange={e => setCreateForm({...createForm, videoUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ไฟล์สรุป</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={createForm.summaryUrl} onChange={e => setCreateForm({...createForm, summaryUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์สไลด์ประกอบ</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={createForm.slideUrl} onChange={e => setCreateForm({...createForm, slideUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ Infographic</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={createForm.infographicUrl} onChange={e => setCreateForm({...createForm, infographicUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ Mind Map</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={createForm.mindmapUrl} onChange={e => setCreateForm({...createForm, mindmapUrl: e.target.value})} />
                                        </div>
                                    </div>

                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                                        <label className="block text-sm font-bold text-blue-800 mb-2 flex items-center"><Upload className="w-4 h-4 mr-2"/> นำเข้าโจทย์จาก CSV (Import)</label>
                                        <input type="file" accept=".csv" onChange={handleFileUpload} ref={fileInputRef} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white file:text-blue-700 hover:file:bg-blue-50 cursor-pointer" />
                                        <div className="mt-2 text-xs text-blue-600">
                                            รองรับรูปแบบ: <code>Question, Option1, Option2, Option3, Option4, Answer(1-4/A-D), Explanation</code>
                                        </div>
                                    </div>

                                    <hr className="my-6 border-gray-200"/>
                                    <h4 className="font-bold text-gray-700 mb-4">รายการคำถาม ({createForm.questions.length})</h4>
                                    <QuestionListEditor 
                                        questions={createForm.questions} 
                                        onChange={(newQs) => setCreateForm({...createForm, questions: newQs})} 
                                    />
                                </div>

                                <div className="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 sticky bottom-0 z-10">
                                    <button onClick={() => setIsOpen(false)} className="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-200 transition">ยกเลิก</button>
                                    <button onClick={handleCreate} className="px-6 py-2 rounded-lg bg-green-600 text-white font-bold shadow hover:bg-green-700 hover:shadow-lg transition flex items-center">
                                        <Save size={18} className="mr-2"/> บันทึกข้อสอบ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Exam List */}
                    <div className="space-y-2">
                        {exams.map(e => (
                            <div key={e.id} className="flex items-center justify-between rounded border bg-white p-4 shadow-sm hover:border-blue-300 transition">
                                <div>
                                    <span className="font-bold text-gray-800 text-lg">{e.title}</span>
                                    <span className="ml-3 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">({e.questions?.length || 0} ข้อ / {e.timeLimit} นาที)</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => handleEdit(e)} className="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition" title="แก้ไขข้อสอบ"><Edit size={18}/></button>
                                    <button onClick={() => setDeleteId(e.id)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="ลบข้อสอบ"><Trash2 size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Edit Exam Modal */}
                    {editingExam && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm overflow-y-auto">
                            <div className="w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl sticky top-0 z-10">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center"><Edit className="w-5 h-5 mr-2 text-blue-600"/> แก้ไขข้อสอบ</h3>
                                    <button onClick={() => setEditingExam(null)} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                                </div>
                                
                                <div className="p-6 overflow-y-auto flex-1">
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อวิชา</label>
                                            <input className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={editingExam.title} onChange={e => setEditingExam({...editingExam, title: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">เวลาสอบ (นาที)</label>
                                            <input type="number" className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={editingExam.timeLimit} onChange={e => setEditingExam({...editingExam, timeLimit: parseInt(e.target.value)})} />
                                        </div>
                                    </div>
                                    
                                    {/* URLs Inputs for Edit */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ไฟล์ข้อสอบฉบับเต็ม (PDF)</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={editingExam.fullFileUrl || ''} onChange={e => setEditingExam({...editingExam, fullFileUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์วิดีโอเฉลย/สอน</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="YouTube URL..." value={editingExam.videoUrl || ''} onChange={e => setEditingExam({...editingExam, videoUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ไฟล์สรุป</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={editingExam.summaryUrl || ''} onChange={e => setEditingExam({...editingExam, summaryUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์สไลด์ประกอบ</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={editingExam.slideUrl || ''} onChange={e => setEditingExam({...editingExam, slideUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ Infographic</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={editingExam.infographicUrl || ''} onChange={e => setEditingExam({...editingExam, infographicUrl: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">ลิงก์ Mind Map</label>
                                            <input className="w-full rounded border p-2 text-sm" placeholder="URL..." value={editingExam.mindmapUrl || ''} onChange={e => setEditingExam({...editingExam, mindmapUrl: e.target.value})} />
                                        </div>
                                    </div>

                                    <QuestionListEditor 
                                        questions={editingExam.questions} 
                                        onChange={(newQs) => setEditingExam({...editingExam, questions: newQs})} 
                                    />
                                </div>

                                <div className="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 sticky bottom-0 z-10">
                                    <button onClick={() => setEditingExam(null)} className="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-200 transition">ยกเลิก</button>
                                    <button onClick={handleUpdateExam} className="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold shadow hover:bg-blue-700 hover:shadow-lg transition flex items-center">
                                        <Save size={18} className="mr-2"/> บันทึกการแก้ไข
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <ConfirmationModal 
                        isOpen={!!deleteId} 
                        onClose={() => setDeleteId(null)} 
                        onConfirm={handleDelete} 
                        title="ยืนยันการลบ" 
                        message="คุณต้องการลบข้อสอบชุดนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้" 
                        confirmText="ลบข้อสอบ"
                        confirmColor="bg-red-600 hover:bg-red-700"
                    />
                </div>
            );
        }

        function AdminContentManager() {
            const [items, setItems] = useState([]);
            const [form, setForm] = useState({ title: '', url: '', category: '', type: 'document' });
            const [deleteItem, setDeleteItem] = useState(null);
            const [editingItem, setEditingItem] = useState(null);

            const reload = () => {
                Promise.all([getDocs(getAppCollection('documents')), getDocs(getAppCollection('videos'))]).then(([d, v]) => {
                    setItems([...d.docs.map(x => ({id: x.id, ...x.data(), type: 'document'})), ...v.docs.map(x => ({id: x.id, ...x.data(), type: 'video'}))]);
                });
            };
            useEffect(() => { reload(); }, []);

            const handleAdd = async () => {
                if (!form.title || !form.url) return;
                await addDoc(getAppCollection(form.type === 'document' ? 'documents' : 'videos'), { 
                    title: form.title, url: form.url, category: form.category, type: form.type 
                });
                setForm({ title: '', url: '', category: '', type: 'document' });
                reload();
            };

            const handleDelete = async () => {
                if(deleteItem) {
                   await deleteDoc(getAppDoc(deleteItem.type === 'document' ? 'documents' : 'videos', deleteItem.id));
                   reload();
                }
            };

            const handleUpdateContent = async () => {
                if (!editingItem || !editingItem.title || !editingItem.url) return alert('กรุณากรอกข้อมูลให้ครบ');
                try {
                    // Use the existing type to determine collection. Changing type is not supported in edit for simplicity.
                    const collectionName = editingItem.type === 'document' ? 'documents' : 'videos';
                    await updateDoc(getAppDoc(collectionName, editingItem.id), {
                        title: editingItem.title,
                        url: editingItem.url,
                        category: editingItem.category
                    });
                    setEditingItem(null);
                    reload();
                } catch (err) {
                    console.error(err);
                    alert("เกิดข้อผิดพลาดในการแก้ไข");
                }
            };

            return (
                <div>
                    <h3 className="mb-4 text-xl font-bold">เนื้อหาเสริม</h3>
                    <div className="mb-6 grid gap-2 rounded bg-gray-50 p-4 border md:grid-cols-4">
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="ชื่อเรื่อง" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="URL (Link)" value={form.url} onChange={e => setForm({...form, url: e.target.value})} />
                        <input className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" placeholder="หมวดหมู่" value={form.category} onChange={e => setForm({...form, category: e.target.value})} />
                        <select className="rounded border p-2 outline-none focus:ring-1 focus:ring-blue-500" value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                            <option value="document">เอกสาร</option>
                            <option value="video">วิดีโอ</option>
                        </select>
                        <button onClick={handleAdd} className="md:col-span-4 rounded bg-blue-600 py-2 text-white hover:bg-blue-700 font-medium transition">เพิ่มรายการ</button>
                    </div>

                    <div className="space-y-2">
                        {items.map(item => (
                            <div key={item.id} className="flex items-center justify-between rounded border bg-white p-3 hover:shadow-sm transition">
                                <div className="flex items-center gap-3 max-w-[70%]">
                                    {item.type === 'video' ? <PlayCircle size={20} className="text-red-500 flex-shrink-0"/> : <FileText size={20} className="text-blue-500 flex-shrink-0"/>}
                                    <div className="overflow-hidden">
                                        <span className="font-medium block truncate">{item.title}</span>
                                        <a href={item.url} target="_blank" className="text-xs text-blue-400 hover:underline truncate block">{item.url}</a>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-shrink-0">
                                    <button onClick={() => setEditingItem(item)} className="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition" title="แก้ไข"><Edit size={18}/></button>
                                    <button onClick={() => setDeleteItem(item)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="ลบ"><Trash2 size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Edit Content Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm">
                            <div className="w-full max-w-lg bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in-up">
                                <div className="p-6 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-gray-800 flex items-center">
                                        <Edit className="w-5 h-5 mr-2 text-blue-600"/> แก้ไข{editingItem.type === 'document' ? 'เอกสาร' : 'วิดีโอ'}
                                    </h3>
                                    <button onClick={() => setEditingItem(null)}><X className="text-gray-400 hover:text-gray-600"/></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อเรื่อง</label>
                                        <input className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" 
                                            value={editingItem.title} 
                                            onChange={e => setEditingItem({...editingItem, title: e.target.value})} 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">URL (Link)</label>
                                        <input className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" 
                                            value={editingItem.url} 
                                            onChange={e => setEditingItem({...editingItem, url: e.target.value})} 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">หมวดหมู่</label>
                                        <input className="w-full rounded border p-2 focus:ring-2 focus:ring-blue-500 outline-none" 
                                            value={editingItem.category} 
                                            onChange={e => setEditingItem({...editingItem, category: e.target.value})} 
                                        />
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 flex justify-end gap-2 border-t">
                                    <button onClick={() => setEditingItem(null)} className="px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-200 transition">ยกเลิก</button>
                                    <button onClick={handleUpdateContent} className="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 shadow transition flex items-center">
                                        <Save size={16} className="mr-2"/> บันทึก
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <ConfirmationModal 
                        isOpen={!!deleteItem} 
                        onClose={() => setDeleteItem(null)} 
                        onConfirm={handleDelete} 
                        title="ยืนยันการลบ" 
                        message={`คุณต้องการลบรายการ "${deleteItem?.title}" ใช่หรือไม่?`}
                        confirmText="ลบรายการ"
                        confirmColor="bg-red-600 hover:bg-red-700"
                    />
                </div>
            );
        }

        // --- Utility Components ---
        function NavBtn({ active, onClick, icon, label }) {
            return <button onClick={onClick} className={`flex items-center space-x-2 rounded-lg px-3 py-2 text-sm font-medium transition ${active ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100'}`}>{icon}<span>{label}</span></button>;
        }
        function MobileBtn({ active, onClick, label }) {
            return <button onClick={onClick} className={`block w-full rounded-md px-3 py-2 text-left font-medium ${active ? 'bg-blue-50 text-blue-600' : 'text-gray-700 hover:bg-gray-50'}`}>{label}</button>;
        }
        function AdminBtn({ active, onClick, icon, label }) {
            return <button onClick={onClick} className={`flex w-full items-center space-x-3 rounded-lg px-3 py-2 transition ${active ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}>{icon}<span>{label}</span></button>;
        }

        // Mount App
        const root = createRoot(document.getElementById('root'));
        root.render(<ExamApp />);
    </script>
</body>
</html>
